<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RefTrack â€” Basketbol Hakem Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #090b0f;
  --surf: #111418;
  --surf2: #181c22;
  --border: #1e2530;
  --acc: #f97316;
  --acc2: #fb923c;
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #eab308;
  --blue: #60a5fa;
  --text: #f0f4f8;
  --muted: #64748b;
  --muted2: #94a3b8;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}

/* LOGIN SCREEN */
#login-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10000;gap:0;padding:20px}
.login-card{background:var(--surf);border:1px solid var(--border);border-radius:20px;padding:40px 40px;width:100%;max-width:440px;box-shadow:0 32px 80px rgba(0,0,0,.5)}
.login-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:32px;color:var(--acc);text-align:center;margin-bottom:4px}
.login-logo span{color:var(--text)}
.login-sub{text-align:center;font-size:11px;font-family:'DM Mono',monospace;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:32px}
.login-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--muted);font-size:12px}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.google-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;padding:13px 20px;background:var(--surf2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;margin-bottom:16px}
.google-btn:hover{border-color:var(--acc);background:rgba(249,115,22,.08)}
.google-btn svg{flex-shrink:0}
.login-name-step{display:none}
.login-step-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;margin-bottom:4px;text-align:center}
.login-step-sub{font-size:12px;color:var(--muted);text-align:center;margin-bottom:22px;line-height:1.6}
.login-input{background:var(--surf2);border:2px solid var(--border);border-radius:10px;padding:13px 16px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;outline:none;transition:border-color .15s;width:100%;margin-bottom:6px}
.login-input:focus{border-color:var(--acc)}
.login-input-hint{font-size:10px;font-family:'DM Mono',monospace;color:var(--muted);margin-bottom:16px;letter-spacing:.5px}
.login-user-info{display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(249,115,22,.07);border:1px solid rgba(249,115,22,.2);border-radius:10px;margin-bottom:20px}
.login-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;flex-shrink:0}
.login-avatar-placeholder{width:38px;height:38px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;color:#fff;font-weight:700}
.login-user-name{font-size:13px;font-weight:600}
.login-user-email{font-size:11px;color:var(--muted)}
/* PROFILE / LOGOUT sidebar */
.user-widget{display:flex;align-items:center;gap:9px;padding:10px 12px;border-radius:10px;background:var(--surf2);border:1px solid var(--border);margin-top:auto;cursor:pointer;transition:all .2s}
.user-widget:hover{border-color:var(--acc)}
.user-widget-av{width:28px;height:28px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.user-widget-info{flex:1;min-width:0}
.user-widget-name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-widget-role{font-size:9px;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:.5px;text-transform:uppercase;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px}
.spin{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-title{font-family:'Syne',sans-serif;font-size:22px;color:var(--acc);font-weight:700}
.load-sub{font-size:12px;color:var(--muted)}

/* SYNC */
#sync{position:fixed;top:14px;right:14px;z-index:300;display:flex;align-items:center;gap:7px;background:var(--surf);border:1px solid var(--border);border-radius:20px;padding:5px 13px;font-size:11px;font-family:'DM Mono',monospace;color:var(--muted2)}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--green)}
.sdot.syncing{background:var(--yellow);animation:blink 0.8s infinite}
.sdot.error{background:var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* SIDEBAR */
.sidebar{position:fixed;left:0;top:0;width:218px;height:100vh;background:var(--surf);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 16px;z-index:100}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:21px;color:var(--acc);letter-spacing:-.5px;margin-bottom:4px}
.logo span{color:var(--text)}
.logo-sub{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:32px}
.nav{display:flex;flex-direction:column;gap:2px;flex:1}
.ns{font-size:9px;font-family:'DM Mono',monospace;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:14px 10px 4px}
.ni{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--muted2);transition:all .15s;border:none;background:none;text-align:left;width:100%}
.ni:hover{background:var(--surf2);color:var(--text)}
.ni.active{background:var(--acc);color:#fff;font-weight:500}
.ni .ic{font-size:16px;min-width:20px;text-align:center}

/* MAIN */
.main{margin-left:218px;padding:28px 32px;min-height:100vh}
.page{display:none}
.page.active{display:block}

/* HEADER */
.ph{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px}
.pt{font-family:'Syne',sans-serif;font-weight:800;font-size:30px;line-height:1.1}
.pt span{color:var(--acc)}
.ps{color:var(--muted);font-size:13px;margin-top:3px}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.sc{background:var(--surf);border:1px solid var(--border);border-radius:13px;padding:18px 20px;position:relative;overflow:hidden;transition:border-color .2s}
.sc:hover{border-color:var(--acc)}
.sl{font-size:10px;font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
.sv{font-family:'Syne',sans-serif;font-weight:700;font-size:26px}
.ss{font-size:11px;color:var(--muted);margin-top:3px}
.si{position:absolute;right:16px;top:16px;font-size:22px;opacity:.12}

/* DASHBOARD HERO */
.dash-hero{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding:28px 32px;background:linear-gradient(135deg,rgba(249,115,22,.08) 0%,rgba(249,115,22,.02) 50%,transparent 100%);border:1px solid rgba(249,115,22,.12);border-radius:18px;position:relative;overflow:hidden}
.dash-hero::before{content:'';position:absolute;right:-60px;top:-60px;width:260px;height:260px;border-radius:50%;border:1px solid rgba(249,115,22,.07);pointer-events:none}
.dash-hero::after{content:'';position:absolute;right:-20px;top:-20px;width:160px;height:160px;border-radius:50%;border:1px solid rgba(249,115,22,.05);pointer-events:none}
.dash-greeting{font-size:11px;font-family:'DM Mono',monospace;letter-spacing:2px;text-transform:uppercase;color:var(--acc);margin-bottom:6px}
.dash-name{font-family:'Syne',sans-serif;font-weight:800;font-size:28px;line-height:1.15;margin-bottom:5px}
.dash-name span{color:var(--acc)}
.dash-date{font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:10px}
.dash-love{font-size:11px;color:var(--muted2);font-style:italic;max-width:420px;line-height:1.5}
.dash-sync-btn{display:flex;align-items:center;gap:7px;padding:8px 16px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;color:var(--muted2);font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap}
.dash-sync-btn:hover{background:rgba(249,115,22,.1);border-color:rgba(249,115,22,.3);color:var(--acc)}

/* DASHBOARD STATS */
.dash-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px}
.ds-card{background:var(--surf);border:1px solid var(--border);border-radius:14px;padding:16px 18px;display:flex;align-items:center;gap:14px;transition:all .2s;position:relative;overflow:hidden}
.ds-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.015),transparent);pointer-events:none}
.ds-clickable{cursor:pointer}
.ds-clickable:hover{border-color:var(--acc);transform:translateY(-2px);box-shadow:0 8px 28px rgba(249,115,22,.12)}
.ds-icon{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ds-body{flex:1;min-width:0}
.ds-label{font-size:9px;font-family:'DM Mono',monospace;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.ds-val{font-family:'Syne',sans-serif;font-weight:700;font-size:22px;color:var(--acc);line-height:1;margin-bottom:2px}
.ds-sub{font-size:10px;color:var(--muted)}
.ds-arrow{font-size:22px;color:var(--acc);font-weight:300;opacity:.5;flex-shrink:0;transition:transform .2s}
.ds-clickable:hover .ds-arrow{transform:translateX(3px);opacity:1}

/* DASHBOARD CATS */
.dash-cats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px}
.dcat{background:var(--surf);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.dcat::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.02),transparent);pointer-events:none}
.dcat:hover{transform:translateY(-3px);box-shadow:0 12px 32px rgba(0,0,0,.25)}
.dcat:nth-child(1):hover{border-color:rgba(249,115,22,.4);box-shadow:0 12px 32px rgba(249,115,22,.1)}
.dcat:nth-child(2):hover{border-color:rgba(34,197,94,.4);box-shadow:0 12px 32px rgba(34,197,94,.1)}
.dcat:nth-child(3):hover{border-color:rgba(96,165,250,.4);box-shadow:0 12px 32px rgba(96,165,250,.1)}
.dcat-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.dcat-ico{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.dcat-label{font-size:11px;font-family:'DM Mono',monospace;letter-spacing:.5px;color:var(--muted2);flex:1}
.dcat-arr{width:16px;height:16px;color:var(--muted);flex-shrink:0;transition:transform .2s;opacity:.5}
.dcat:hover .dcat-arr{transform:translateX(3px);opacity:1}
.dcat-num{font-family:'Syne',sans-serif;font-weight:800;font-size:38px;line-height:1;margin-bottom:10px}
.dcat-chips{display:flex;flex-wrap:wrap;gap:4px}
.dcat-chips .cc-chip{background:rgba(255,255,255,.05);border-radius:5px;padding:2px 7px;font-size:10px;font-family:'DM Mono',monospace;white-space:nowrap}

/* DASHBOARD BOTTOM */
.dash-bottom{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}

/* CAT CARDS */

.cat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:22px}
.cc{background:var(--surf);border:1px solid var(--border);border-radius:13px;padding:18px 20px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.cc:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.cc-val{font-family:'Syne',sans-serif;font-weight:700;font-size:24px;margin:6px 0}
.cc-detail{font-size:10px;color:var(--muted);margin-top:6px;line-height:1.9;display:flex;flex-wrap:wrap;gap:3px}
.cc-chip{background:rgba(255,255,255,.05);border-radius:4px;padding:1px 6px;white-space:nowrap}

/* CARD */
.card{background:var(--surf);border:1px solid var(--border);border-radius:13px;padding:22px;margin-bottom:18px}
.card-title{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}

/* TABLE */
.tbl{width:100%;border-collapse:collapse}
.tbl th{font-size:9px;font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;color:var(--muted);text-align:left;padding:0 10px 10px;border-bottom:1px solid var(--border)}
.tbl td{padding:12px 10px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--surf2)}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:2px 9px;border-radius:20px;font-size:11px;font-weight:500;font-family:'DM Mono',monospace}
.b-green{background:rgba(34,197,94,.12);color:var(--green)}
.b-red{background:rgba(239,68,68,.12);color:var(--red)}
.b-yellow{background:rgba(234,179,8,.12);color:var(--yellow)}
.b-orange{background:rgba(249,115,22,.12);color:var(--acc)}
.b-blue{background:rgba(96,165,250,.12);color:var(--blue)}
.role-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;background:rgba(249,115,22,.1);color:var(--acc);border:1px solid rgba(249,115,22,.2)}

/* FORM */
.fg{display:flex;flex-direction:column;gap:5px}
.fg label{font-size:9px;font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
.fg input,.fg select,.fg textarea{background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .15s;width:100%}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--acc)}
.fg select option{background:var(--surf2)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}

/* BTNS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 20px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--acc);color:#fff}
.btn-primary:hover{background:var(--acc2);transform:translateY(-1px)}
.btn-ghost{background:var(--surf2);color:var(--muted2);border:1px solid var(--border)}
.btn-ghost:hover{color:var(--text);border-color:var(--muted)}
.btn-danger{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-sm{padding:5px 12px;font-size:11px}
.btn-green{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2)}

/* UPCOMING ALERT */
.ua{background:linear-gradient(135deg,rgba(249,115,22,.1),rgba(249,115,22,.03));border:1px solid rgba(249,115,22,.25);border-radius:11px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.ua-dot{width:9px;height:9px;border-radius:50%;background:var(--acc);animation:blink 1.5s ease-in-out infinite;flex-shrink:0}
.ua-title{font-weight:600;font-size:14px}
.ua-sub{font-size:11px;color:var(--muted);margin-top:2px}
.countdown{font-family:'DM Mono',monospace;font-size:18px;font-weight:500;color:var(--acc);letter-spacing:2px}

/* TABS */
.tabs{display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap}
.tab-btn{padding:8px 18px;border-radius:9px;border:1px solid var(--border);background:var(--surf);color:var(--muted2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s}
.tab-btn:hover{border-color:var(--acc);color:var(--text)}
.tab-btn.active{background:var(--acc);color:#fff;border-color:var(--acc)}

/* SUGGEST */
.sug-wrap{position:relative}
.sug-box{position:absolute;top:100%;left:0;right:0;background:var(--surf2);border:1px solid var(--acc);border-radius:8px;max-height:180px;overflow-y:auto;z-index:400;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4);margin-top:2px}
.sug-box.open{display:block}
.sug-item{padding:9px 13px;font-size:12px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s}
.sug-item:last-child{border-bottom:none}
.sug-item:hover{background:var(--acc);color:#fff}
.sug-item mark{background:transparent;color:var(--acc);font-weight:700}
.sug-item:hover mark{color:#fff}

/* MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:8000;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--surf);border:1px solid var(--border);border-radius:16px;padding:26px 30px;width:460px;max-width:94vw;box-shadow:0 24px 60px rgba(0,0,0,.5)}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:17px;margin-bottom:3px}
.modal-sub{font-size:11px;color:var(--muted);margin-bottom:18px}
.modal-actions{display:flex;gap:9px;justify-content:flex-end;margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}

/* FINANCE */
.bar-row{display:flex;align-items:center;gap:10px;font-size:12px;margin-bottom:8px}
.bar-label{width:38px;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px}
.bar-track{flex:1;height:7px;background:var(--surf2);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;background:var(--acc);transition:width .8s ease}
.bar-val{width:68px;text-align:right;font-family:'DM Mono',monospace;font-size:11px;color:var(--muted2)}

/* NOTIF TOGGLE */
.toggle{position:relative;width:42px;height:22px;background:var(--border);border-radius:11px;cursor:pointer;transition:background .2s;border:none;flex-shrink:0}
.toggle.on{background:var(--acc)}
.toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:8px;background:#fff;top:3px;left:3px;transition:left .2s}
.toggle.on::after{left:23px}
.ni-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surf2);border-radius:9px;border:1px solid var(--border);margin-bottom:8px}

/* TOAST */
.toast-wrap{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--surf);border:1px solid var(--border);border-left:3px solid var(--acc);border-radius:9px;padding:12px 16px;font-size:12px;min-width:260px;animation:tin .3s ease;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.toast.ok{border-left-color:var(--green)}
.toast.err{border-left-color:var(--red)}
@keyframes tin{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}

/* EMPTY */
.empty{text-align:center;padding:40px;color:var(--muted)}
.empty-ic{font-size:36px;margin-bottom:10px;opacity:.35}
.empty-tx{font-size:13px}

/* CSV DROP ZONE */
.csv-drop{border:2px dashed var(--border);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px}
.csv-drop:hover{border-color:var(--acc);background:rgba(249,115,22,.03)}
.csv-err{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:10px 14px;color:var(--red);font-size:12px;margin-top:10px}

/* TWO COL */
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px}

.app-hidden { display: none !important; }
  .sidebar{width:100%;height:auto;position:fixed;bottom:0;left:0;top:auto;flex-direction:column;padding:0;border-right:none;border-top:1px solid var(--border);z-index:200}
  .logo,.logo-sub{display:none}
  .nav{flex-direction:row;overflow-x:auto;gap:0;padding:0;scrollbar-width:none}
  .nav::-webkit-scrollbar{display:none}
  .ns{display:none}
  .ni{flex-direction:column;gap:2px;padding:8px 6px;font-size:9px;min-width:52px;text-align:center;border-radius:0;white-space:nowrap;flex:1}
  .ni .ic{font-size:18px;min-width:unset}
  .ni.active{background:var(--surf2);color:var(--acc);border-top:2px solid var(--acc)}
  .main{margin-left:0;padding:14px 12px 80px}
  .ph{flex-direction:column;gap:10px;margin-bottom:18px}
  .pt{font-size:20px}
  .stats-row{grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
  .cat-row{grid-template-columns:1fr;gap:10px;margin-bottom:14px}
  .sc{padding:12px 14px}
  .sv{font-size:18px}
  .si{display:none}
  .two-col{grid-template-columns:1fr}
  .form-grid{grid-template-columns:1fr}
  .card{padding:12px;overflow-x:auto}
  .tbl{min-width:460px}
  .ua{flex-direction:column;align-items:flex-start}
  #sync{top:6px;right:6px;font-size:10px;padding:4px 10px}
  .modal{padding:18px 16px}
  /* Dashboard mobile */
  .dash-hero{padding:18px 16px;margin-bottom:16px;flex-direction:column;gap:12px}
  .dash-hero::before,.dash-hero::after{display:none}
  .dash-name{font-size:20px}
  .dash-love{font-size:10px}
  .dash-stats{grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
  .ds-card{padding:12px 13px;gap:10px}
  .ds-icon{width:36px;height:36px;font-size:15px}
  .ds-val{font-size:18px}
  .ds-arrow{display:none}
  .dash-cats{grid-template-columns:1fr;gap:9px;margin-bottom:14px}
  .dcat-num{font-size:28px}
  .dash-bottom{grid-template-columns:1fr;gap:12px}
}
</style>
  <link rel="manifest" id="pwa-manifest">
  <meta name="theme-color" content="#f97316">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RefTrack">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='112' fill='%23090b0f'/%3E%3Crect width='512' height='512' rx='112' fill='url(%23g)'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%23f97316' stop-opacity='.18'/%3E%3Cstop offset='1' stop-color='%23090b0f' stop-opacity='0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='256' cy='220' r='90' fill='none' stroke='%23f97316' stroke-width='28'/%3E%3Cellipse cx='256' cy='220' rx='0' ry='90' fill='none' stroke='%23f97316' stroke-width='14'/%3E%3Cline x1='166' y1='220' x2='346' y2='220' stroke='%23f97316' stroke-width='14'/%3E%3Cline x1='256' y1='130' x2='256' y2='310' stroke='%23f97316' stroke-width='14'/%3E%3Crect x='178' y='340' width='156' height='22' rx='11' fill='%23f97316' opacity='.7'/%3E%3Crect x='218' y='368' width='76' height='16' rx='8' fill='%23f97316' opacity='.45'/%3E%3Ctext x='256' y='490' text-anchor='middle' font-family='Arial Black,sans-serif' font-size='52' font-weight='900' fill='%23f97316' letter-spacing='-2'%3ERT%3C/text%3E%3C/svg%3E">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='112' fill='%23090b0f'/%3E%3Ccircle cx='256' cy='220' r='90' fill='none' stroke='%23f97316' stroke-width='28'/%3E%3Cline x1='166' y1='220' x2='346' y2='220' stroke='%23f97316' stroke-width='14'/%3E%3Cline x1='256' y1='130' x2='256' y2='310' stroke='%23f97316' stroke-width='14'/%3E%3Crect x='178' y='340' width='156' height='22' rx='11' fill='%23f97316' opacity='.7'/%3E%3Ctext x='256' y='490' text-anchor='middle' font-family='Arial Black' font-size='52' font-weight='900' fill='%23f97316'%3ERT%3C/text%3E%3C/svg%3E">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>



<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <!-- Step 1: Google Sign In -->
    <div id="login-step-google">
      <div class="login-logo">Ref<span>Track</span></div>
      <div class="login-sub">ğŸ€ Basketbol Hakem Paneli</div>

      <!-- Feature badges -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:22px">
        <div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:rgba(249,115,22,.07);border:1px solid rgba(249,115,22,.15);border-radius:9px">
          <span style="font-size:16px">ğŸ“‹</span>
          <div>
            <div style="font-size:10px;font-weight:600;color:var(--text)">MaÃ§ Takibi</div>
            <div style="font-size:9px;color:var(--muted)">TÃ¼m atamalar</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.15);border-radius:9px">
          <span style="font-size:16px">ğŸ’°</span>
          <div>
            <div style="font-size:10px;font-weight:600;color:var(--text)">Ãœcret Takibi</div>
            <div style="font-size:9px;color:var(--muted)">KazanÃ§ & Ã¶deme</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:rgba(96,165,250,.07);border:1px solid rgba(96,165,250,.15);border-radius:9px">
          <span style="font-size:16px">ğŸ””</span>
          <div>
            <div style="font-size:10px;font-weight:600;color:var(--text)">Bildirimler</div>
            <div style="font-size:9px;color:var(--muted)">MaÃ§ hatÄ±rlatma</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:rgba(234,179,8,.07);border:1px solid rgba(234,179,8,.15);border-radius:9px">
          <span style="font-size:16px">ğŸ“Š</span>
          <div>
            <div style="font-size:10px;font-weight:600;color:var(--text)">Ä°statistikler</div>
            <div style="font-size:9px;color:var(--muted)">KiÅŸisel dashboard</div>
          </div>
        </div>
      </div>

      <div style="text-align:center;font-size:11px;color:var(--muted);margin-bottom:16px;font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase">Her hakem iÃ§in kiÅŸisel filtreleme</div>

      <button class="google-btn" onclick="signInWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.29-8.16 2.29-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
        Google ile GiriÅŸ Yap
      </button>
      <div id="login-error" style="display:none;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:10px 14px;color:var(--red);font-size:12px;margin-top:8px;text-align:center"></div>
      <div style="text-align:center;margin-top:16px;font-size:10px;color:var(--muted)">ğŸ”’ GiriÅŸ yaparak verileriniz gÃ¼venle hesabÄ±nÄ±za baÄŸlanÄ±r</div>
    </div>

    <!-- Step 2: Set Referee Name -->
    <div id="login-step-name" class="login-name-step" style="display:none">
      <!-- Progress indicator -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:22px">
        <div style="width:24px;height:24px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0">âœ“</div>
        <div style="height:2px;flex:1;background:var(--acc);border-radius:1px"></div>
        <div style="width:24px;height:24px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0">2</div>
        <div style="height:2px;flex:1;background:var(--border);border-radius:1px"></div>
        <div style="width:24px;height:24px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:400;color:var(--muted);flex-shrink:0">3</div>
      </div>
      <div class="login-step-title">ğŸ€ Hakem AdÄ±nÄ± Belirle</div>
      <div class="login-step-sub">Programlarda tam olarak gÃ¶rÃ¼ndÃ¼ÄŸÃ¼ ÅŸekilde bÃ¼yÃ¼k harflerle yaz.<br><strong style="color:var(--acc)">Bu ad, seni maÃ§larda otomatik tanÄ±mak iÃ§in kullanÄ±lÄ±r.</strong></div>

      <!-- Google user info -->
      <div id="login-user-badge" class="login-user-info">
        <div class="login-avatar-placeholder" id="login-av-letter">?</div>
        <div style="flex:1">
          <div class="login-user-name" id="login-display-name">â€”</div>
          <div class="login-user-email" id="login-email" style="font-size:10px;color:var(--muted)">â€”</div>
          <div style="font-size:9px;color:var(--green);margin-top:2px;font-family:'DM Mono',monospace">âœ“ Google ile doÄŸrulandÄ±</div>
        </div>
      </div>

      <div style="position:relative;margin-bottom:6px">
        <input class="login-input" id="login-ref-name" type="text" placeholder="AD SOYAD (BÃœYÃœK HARF)" maxlength="60"
          style="padding-right:40px"
          oninput="this.value=this.value.toUpperCase();validateRefNameInput(this)"
          onkeydown="if(event.key==='Enter')confirmRefName()">
        <div id="ref-name-check" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;display:none">âœ…</div>
      </div>
      <div class="login-input-hint">âš ï¸ Programdaki hakem listesiyle birebir eÅŸleÅŸmeli Â· Ã–rn: AHMET YILMAZ</div>

      <!-- Example names hint -->
      <div style="background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:10px 13px;margin-bottom:14px">
        <div style="font-size:10px;color:var(--muted);margin-bottom:5px;font-family:'DM Mono',monospace;letter-spacing:.5px">Ã–RNEK FORMAT:</div>
        <div style="font-size:11px;color:var(--muted2);line-height:1.7">AHMET YILMAZ &nbsp;Â·&nbsp; MEHMET Ã‡ELÄ°K &nbsp;Â·&nbsp; AYÅE KAYA<br>ÅEMSETTÄ°N KEMAL ATAK &nbsp;Â·&nbsp; RECEP DAÄDELEN</div>
      </div>

      <button class="btn btn-primary" style="width:100%;justify-content:center;font-size:14px;padding:13px" onclick="confirmRefName()">
        âœ“ Panele GiriÅŸ Yap
      </button>
      <button style="width:100%;background:none;border:none;color:var(--muted);font-size:11px;margin-top:10px;cursor:pointer;font-family:'DM Sans',sans-serif" onclick="signOutUser()">â† FarklÄ± Google hesabÄ±yla giriÅŸ yap</button>
    </div>
  </div>
</div>

<div id="loading">
  <div class="load-title">ğŸ€ RefTrack</div>
  <div class="spin"></div>
  <div class="load-sub" id="load-sub-txt">YÃ¼kleniyor...</div>
  <button id="loading-skip" onclick="document.getElementById('loading').style.display='none';if(window._renderAll)window._renderAll();"
    style="display:none;margin-top:20px;padding:9px 22px;background:rgba(249,115,22,.15);border:1px solid rgba(249,115,22,.4);border-radius:9px;color:#f97316;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600">
    Devam Et â†’
  </button>
</div>
<script>
// GÃ¼venlik timeout - 5sn sonra "Devam Et" butonu gÃ¶ster, 12sn sonra zorla kapat
setTimeout(function(){
  var b=document.getElementById('loading-skip');
  var t=document.getElementById('load-sub-txt');
  if(b){b.style.display='block';}
  if(t){t.textContent='BaÄŸlantÄ± yavaÅŸ...';}
},5000);
setTimeout(function(){
  var l=document.getElementById('loading');
  if(l&&l.style.display!=='none'){
    l.style.display='none';
    if(typeof window._renderAll==='function') window._renderAll();
  }
},12000);
</script>

<div id="sync" class="app-hidden"><div class="sdot syncing" id="sdot"></div><span id="stxt">BaÄŸlanÄ±yor...</span></div>

<nav class="sidebar app-hidden">
  <div>
    <div class="logo">Ref<span>Track</span></div>
    <div class="logo-sub">ğŸ€ Basketbol Hakem</div>
  </div>
  <div class="nav">
    <div class="ns">Ana MenÃ¼</div>
    <button class="ni active" onclick="go('dashboard')"><span class="ic">ğŸ“Š</span>Dashboard</button>
    <button class="ni" onclick="go('upcoming')"><span class="ic">ğŸ“…</span>Gelecek MaÃ§lar</button>
    <button class="ni" onclick="go('past')"><span class="ic">ğŸ•</span>GeÃ§miÅŸ MaÃ§lar</button>
    <button class="ni" onclick="go('finance')"><span class="ic">ğŸ’°</span>Ãœcret Takibi</button>
    <div class="ns">DiÄŸer</div>
    <button class="ni" onclick="go('program')"><span class="ic">ğŸ“‹</span>Program</button>
    <button class="ni" onclick="go('add')"><span class="ic">â•</span>MaÃ§ Ekle</button>
    <button class="ni" onclick="go('notifications')"><span class="ic">ğŸ””</span>Bildirimler</button>
  </div>
  <div class="user-widget" onclick="go('profile')" style="margin-top:12px">
    <div class="user-widget-av" id="sidebar-av">?</div>
    <div class="user-widget-info">
      <div class="user-widget-name" id="sidebar-name">â€”</div>
      <div class="user-widget-role" id="sidebar-role">Hakem</div>
    </div>
    <span style="font-size:14px;opacity:.4">âš™</span>
  </div>
</nav>

<main class="main app-hidden">

<!-- DASHBOARD -->
<div id="page-dashboard" class="page active">

  <!-- Hero Header -->
  <div class="dash-hero">
    <div class="dash-hero-left">
      <div class="dash-greeting" id="dash-greeting">Ä°yi gÃ¼nler</div>
      <div class="dash-name" id="dash-name-span">HoÅŸ <span>Geldiniz</span></div>
      <div class="dash-date" id="today-date"></div>
      <div class="dash-love" id="dash-love-text" style="font-size:11px;color:var(--muted2);font-style:italic;max-width:420px;line-height:1.5">ğŸ€ RefTrack â€” KiÅŸisel hakem takip paneli Â· TÃ¼m veriler <span style="color:var(--acc);font-style:normal;font-weight:600" id="dash-refname-badge">senin adÄ±na</span> filtreleniyor</div>
    </div>
    <div class="dash-hero-right">
      <button class="dash-sync-btn" onclick="manualSync()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        Sync
      </button>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="dash-stats">
    <div class="ds-card ds-clickable" onclick="go('past');setTimeout(()=>{pastMode('month');},80)">
      <div class="ds-icon" style="background:rgba(249,115,22,.12);color:var(--acc)">ğŸ€</div>
      <div class="ds-body">
        <div class="ds-label">Bu Ay MaÃ§</div>
        <div class="ds-val" id="s-month">â€”</div>
        <div class="ds-sub">yÃ¶netildi</div>
      </div>
      <div class="ds-arrow">â€º</div>
    </div>
    <div class="ds-card ds-clickable" onclick="go('upcoming');setTimeout(()=>{upcomingTab('bolge');},80)">
      <div class="ds-icon" style="background:rgba(96,165,250,.12);color:var(--blue)">ğŸ“…</div>
      <div class="ds-body">
        <div class="ds-label">Gelecek MaÃ§lar</div>
        <div class="ds-val" id="s-upcoming" style="color:var(--blue)">â€”</div>
        <div class="ds-sub">planlandÄ±</div>
      </div>
      <div class="ds-arrow" style="color:var(--blue)">â€º</div>
    </div>
    <div class="ds-card">
      <div class="ds-icon" style="background:rgba(34,197,94,.12);color:var(--green)">ğŸ’°</div>
      <div class="ds-body">
        <div class="ds-label">Bu Ay KazanÃ§</div>
        <div class="ds-val" id="s-earn" style="color:var(--green)">â€”</div>
        <div class="ds-sub">toplam</div>
      </div>
    </div>
    <div class="ds-card">
      <div class="ds-icon" style="background:rgba(234,179,8,.12);color:var(--yellow)">â³</div>
      <div class="ds-body">
        <div class="ds-label">Bekleyen Ã–deme</div>
        <div class="ds-val" id="s-unpaid" style="color:var(--yellow)">â€”</div>
        <div class="ds-sub">Ã¶denmedi</div>
      </div>
    </div>
  </div>

  <!-- Kategori KartlarÄ± -->
  <div class="dash-cats">
    <div class="dcat" onclick="_pastTab='bolge';go('past');setTimeout(()=>pastTab('bolge'),80)">
      <div class="dcat-header">
        <div class="dcat-ico" style="background:rgba(249,115,22,.15)">ğŸ“‹</div>
        <div class="dcat-label">BÃ¶lge MaÃ§larÄ±</div>
        <svg class="dcat-arr" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
      <div class="dcat-num" id="cc-bolge" style="color:var(--acc)">â€”</div>
      <div class="dcat-chips" id="cc-bolge-d"></div>
    </div>
    <div class="dcat" onclick="_pastTab='okul';go('past');setTimeout(()=>pastTab('okul'),80)">
      <div class="dcat-header">
        <div class="dcat-ico" style="background:rgba(34,197,94,.15)">ğŸ«</div>
        <div class="dcat-label">Okul Ä°l ve Ä°lÃ§e</div>
        <svg class="dcat-arr" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
      <div class="dcat-num" id="cc-okul" style="color:var(--green)">â€”</div>
      <div class="dcat-chips" id="cc-okul-d"></div>
    </div>
    <div class="dcat" onclick="_pastTab='ozel';go('past');setTimeout(()=>pastTab('ozel'),80)">
      <div class="dcat-header">
        <div class="dcat-ico" style="background:rgba(96,165,250,.15)">ğŸ†</div>
        <div class="dcat-label">Ã–zel Lig & Ãœniversite</div>
        <svg class="dcat-arr" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
      <div class="dcat-num" id="cc-ozel" style="color:var(--blue)">â€”</div>
      <div class="dcat-chips" id="cc-ozel-d"></div>
    </div>
  </div>

  <!-- YaklaÅŸan + Son MaÃ§lar grid -->
  <div class="dash-bottom">
    <div class="card" style="margin-bottom:0">
      <div class="card-title">
        <span style="display:flex;align-items:center;gap:8px"><span style="width:8px;height:8px;border-radius:50%;background:var(--acc);display:inline-block;animation:blink 1.5s infinite"></span>YaklaÅŸan MaÃ§lar</span>
        <button class="btn btn-ghost btn-sm" onclick="go('upcoming')">TÃ¼mÃ¼ â†’</button>
      </div>
      <div id="d-upcoming"></div>
    </div>
    <div class="card" style="margin-bottom:0">
      <div class="card-title"><span>Son MaÃ§lar</span><button class="btn btn-ghost btn-sm" onclick="go('past')">TÃ¼mÃ¼ â†’</button></div>
      <div style="overflow-x:auto">
      <table class="tbl">
        <thead><tr><th>Tarih</th><th>MaÃ§</th><th>Lig</th><th>Rol</th><th>Ãœcret</th><th>Ã–deme</th></tr></thead>
        <tbody id="d-past"></tbody>
      </table>
      </div>
    </div>
  </div>

</div>

<!-- UPCOMING -->
<div id="page-upcoming" class="page">
  <div class="ph">
    <div><div class="pt">Gelecek <span>MaÃ§lar</span></div><div class="ps">PlanlanmÄ±ÅŸ atamalarÄ±nÄ±z</div></div>
    <button class="btn btn-primary" onclick="go('add')">ï¼‹ MaÃ§ Ekle</button>
  </div>
  <div class="tabs">
    <button class="tab-btn active" id="uptab-btn-bolge" onclick="upcomingTab('bolge')">ğŸ“‹ BÃ¶lge MaÃ§larÄ±</button>
    <button class="tab-btn" id="uptab-btn-okul" onclick="upcomingTab('okul')">ğŸ« Okul Ä°l ve Ä°lÃ§e</button>
    <button class="tab-btn" id="uptab-btn-ozel" onclick="upcomingTab('ozel')">ğŸ† Ã–zel Lig & Ãœniversite</button>
  </div>
  <div id="upcoming-list"></div>
</div>

<!-- PAST -->
<div id="page-past" class="page">
  <div class="ph">
    <div><div class="pt">GeÃ§miÅŸ <span>MaÃ§lar</span></div><div class="ps">TamamlanmÄ±ÅŸ atamalarÄ±nÄ±z</div></div>
    <button class="btn btn-primary" onclick="go('add')">ï¼‹ MaÃ§ Ekle</button>
  </div>
  <div class="tabs">
    <button class="tab-btn" id="pasttab-btn-month" onclick="pastTab('month')">ğŸ“… Bu Ay</button>
    <button class="tab-btn active" id="pasttab-btn-bolge" onclick="pastTab('bolge')">ğŸ“‹ BÃ¶lge MaÃ§larÄ±</button>
    <button class="tab-btn" id="pasttab-btn-okul" onclick="pastTab('okul')">ğŸ« Okul Ä°l ve Ä°lÃ§e</button>
    <button class="tab-btn" id="pasttab-btn-ozel" onclick="pastTab('ozel')">ğŸ† Ã–zel Lig & Ãœniversite</button>
  </div>
  <div class="card" style="overflow-x:auto">
    <table class="tbl">
      <thead><tr><th>Tarih</th><th>MaÃ§</th><th>Lig / Kategori</th><th>Lokasyon</th><th>Rol</th><th>Ãœcret</th><th>Ã–deme</th><th>Ä°ÅŸlem</th></tr></thead>
      <tbody id="past-list"></tbody>
    </table>
  </div>
</div>

<!-- FINANCE -->
<div id="page-finance" class="page">
  <div class="ph"><div><div class="pt">Ãœcret <span>Takibi</span></div><div class="ps">KazanÃ§ ve Ã¶deme durumunuz</div></div></div>
  <div class="stats-row">
    <div class="sc"><div class="sl">Toplam KazanÃ§</div><div class="sv" id="f-total">â€”</div><div class="ss">tÃ¼m zamanlar</div><div class="si">ğŸ“ˆ</div></div>
    <div class="sc"><div class="sl">Ã–denen</div><div class="sv" id="f-paid" style="color:var(--green)">â€”</div><div class="ss">tahsil edildi</div><div class="si">âœ…</div></div>
    <div class="sc"><div class="sl">Bekleyen</div><div class="sv" id="f-pend" style="color:var(--yellow)">â€”</div><div class="ss">Ã¶denmedi</div><div class="si">â³</div></div>
    <div class="sc"><div class="sl">Bu Ay</div><div class="sv" id="f-month">â€”</div><div class="ss">aylÄ±k kazanÃ§</div><div class="si">ğŸ“…</div></div>
  </div>
  <div class="two-col">
    <div class="card"><div class="card-title">AylÄ±k KazanÃ§</div><div id="monthly-chart"></div></div>
    <div class="card">
      <div class="card-title"><span>Bekleyen Ã–demeler</span><span class="badge b-yellow" id="pend-count">0</span></div>
      <div id="pend-list"></div>
    </div>
  </div>
</div>

<!-- PROGRAM -->
<div id="page-program" class="page">
  <div class="ph"><div><div class="pt">Hakem <span>ProgramÄ±</span></div><div class="ps" id="prog-page-sub">TÃ¼m kategoriler â€” sadece senin maÃ§larÄ±n</div></div></div>
  <div class="tabs">
    <button class="tab-btn active" id="ptab-hafta" onclick="progTab('hafta')">ğŸ“‹ Hafta ProgramlarÄ±</button>
    <button class="tab-btn" id="ptab-okul" onclick="progTab('okul')">ğŸ« Okul Ä°l ve Ä°lÃ§e</button>
    <button class="tab-btn" id="ptab-ozel" onclick="progTab('ozel')">ğŸ† Ã–zel Lig & Ãœniversite</button>
    <button class="tab-btn" id="ptab-csv" onclick="progTab('csv')" style="border-color:rgba(96,165,250,.4);color:#60a5fa">â¬†ï¸ CSV YÃ¼kle</button>
  </div>

  <!-- Hafta -->
  <div id="progtab-hafta">
    <!-- Active referee indicator -->
    <div style="display:flex;align-items:center;gap:10px;padding:10px 16px;background:rgba(249,115,22,.07);border:1px solid rgba(249,115,22,.2);border-radius:10px;margin-bottom:12px">
      <span style="font-size:14px">ğŸ€</span>
      <div style="font-size:11px;color:var(--muted2)">Aktif hakem:</div>
      <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--acc)" id="prog-active-name">â€”</div>
      <div style="margin-left:auto;font-size:10px;color:var(--muted)">Profil &gt; Hakem AdÄ±nÄ± GÃ¼ncelle ile deÄŸiÅŸtirebilirsiniz</div>
    </div>
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div class="fg" style="flex:1;min-width:160px"><label>Ara</label><input type="text" id="ph-search" placeholder="TakÄ±m veya salon..." oninput="renderHafta()"></div>
        <div class="fg" style="min-width:170px"><label>Hafta</label>
          <select id="ph-week" onchange="renderHafta()">
            <option value="" selected>TÃ¼m haftalar</option>
            <option value="12">12. Hafta (24-30 KasÄ±m 2025)</option>
            <option value="14">14. Hafta (08-14 AralÄ±k 2025)</option>
            <option value="15">15. Hafta (15-21 AralÄ±k 2025)</option>
            <option value="16">16. Hafta (22-28 AralÄ±k 2025)</option>
            <option value="17">17. Hafta (29 Ara-04 Oca 2026)</option>
            <option value="22">22. Hafta (02-08 Åubat 2026)</option>
            <option value="23">23. Hafta (09-15 Åubat 2026)</option>
            <option value="24">24. Hafta (16-22 Åubat 2026)</option>
            <option value="25">25. Hafta (23 Åub-01 Mar 2026)</option>
          </select>
        </div>
        <div class="fg" style="min-width:130px"><label>GÃ¶ster</label>
          <select id="ph-mine" onchange="renderHafta()">
            <option value="mine" selected>â­ Benim maÃ§larÄ±m</option>
            <option value="all">TÃ¼m maÃ§lar</option>
          </select>
        </div>
        <div class="fg" style="min-width:130px"><label>DÃ¶nem</label>
          <select id="ph-period" onchange="renderHafta()">
            <option value="all" selected>TÃ¼mÃ¼</option>
            <option value="past">â® GeÃ§miÅŸ</option>
            <option value="future">â­ Gelecek</option>
          </select>
        </div>
        <div style="align-self:flex-end;padding-bottom:2px"><span class="badge b-orange" id="ph-count">0 maÃ§</span></div>
      </div>
    </div>
    <div class="card" style="overflow-x:auto">
      <table class="tbl"><thead><tr><th>Tarih</th><th>Salon</th><th>Saat</th><th>Ev Sahibi</th><th>Deplasman</th><th>Kategori</th><th>Grup</th><th>RolÃ¼m</th><th>Ekle</th></tr></thead>
      <tbody id="hafta-body"></tbody></table>
    </div>
  </div>

  <!-- Okul -->
  <div id="progtab-okul" style="display:none">
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div class="fg" style="flex:1;min-width:160px"><label>Ara</label><input type="text" id="po-search" placeholder="Salon veya ilÃ§e..." oninput="renderOkul()"></div>
        <div class="fg" style="min-width:120px"><label>Kaynak</label>
          <select id="po-src" onchange="renderOkul()">
            <option value="all">TÃ¼mÃ¼</option><option value="current">GÃ¼ncel</option><option value="arsiv">ArÅŸiv</option>
          </select>
        </div>
        <div style="align-self:flex-end;padding-bottom:2px"><span class="badge b-green" id="po-count">0 maÃ§</span></div>
      </div>
    </div>
    <div class="card" style="overflow-x:auto">
      <table class="tbl"><thead><tr><th>Tarih</th><th>Saat</th><th>Salon</th><th>Organizasyon</th><th>Grup</th><th>1. Hakem</th><th>2. Hakem</th><th>RolÃ¼m</th></tr></thead>
      <tbody id="okul-body"></tbody></table>
    </div>
  </div>

  <!-- CSV Import -->
  <div id="progtab-csv" style="display:none">

    <!-- Kategori seÃ§ici -->
    <div class="tabs" style="margin-bottom:14px">
      <button class="tab-btn active" id="csvcat-btn-bolge" onclick="csvCatTab('bolge')">ğŸ“‹ BÃ¶lge MaÃ§Ä±</button>
      <button class="tab-btn" id="csvcat-btn-okul" onclick="csvCatTab('okul')">ğŸ« Okul Ä°l ve Ä°lÃ§e</button>
      <button class="tab-btn" id="csvcat-btn-ozel" onclick="csvCatTab('ozel')">ğŸ† Ã–zel Lig & Ãœniversite</button>
    </div>

    <!-- â”€â”€ BÃ–LGE â”€â”€ -->
    <div id="csvcat-bolge">
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px">ğŸ“‹ BÃ¶lge MaÃ§Ä± CSV YÃ¼kle</div>
            <div style="font-size:11px;color:var(--muted);margin-top:3px;font-family:'DM Mono',monospace">TARÄ°H Â· SALON Â· SAAT Â· A TAKIMI Â· B TAKIMI Â· KATEGORÄ° Â· GRUP Â· 1.HAKEM Â· 2.HAKEM</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="fg" style="min-width:110px"><label>Hafta No</label><input type="number" id="csv-bolge-week" placeholder="Ã¶r: 26" min="1" max="52"></div>
            <div style="align-self:flex-end">
              <button class="btn btn-primary" onclick="document.getElementById('csv-bolge-input').click()">ğŸ“‚ Dosya SeÃ§</button>
              <input type="file" id="csv-bolge-input" accept=".csv,.tsv,.txt" style="display:none" onchange="handleCsv(event,'bolge')">
            </div>
          </div>
        </div>
        <div class="csv-drop" onclick="document.getElementById('csv-bolge-input').click()"
          ondragover="event.preventDefault();this.style.borderColor='var(--acc)';this.style.background='rgba(249,115,22,.05)'"
          ondragleave="this.style.borderColor='var(--border)';this.style.background=''"
          ondrop="event.preventDefault();this.style.borderColor='var(--border)';this.style.background='';handleCsv({target:{files:event.dataTransfer.files}},'bolge')">
          <div style="font-size:30px;opacity:.35;margin-bottom:8px">ğŸ“„</div>
          <div style="font-size:13px;font-weight:600;color:var(--muted2)">SÃ¼rÃ¼kle & bÄ±rak veya tÄ±kla</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">.csv Â· .tsv Â· tab/virgÃ¼l/noktalÄ± virgÃ¼l ayrÄ±lmÄ±ÅŸ</div>
        </div>
        <div id="csv-bolge-error" class="csv-err" style="display:none"></div>
        <div id="csv-bolge-preview" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px">
            <div style="font-size:13px;font-weight:600">Ã–nizleme â€” <span id="csv-bolge-cnt" style="color:var(--acc)">0</span> maÃ§ &nbsp;<span id="csv-bolge-mine" style="color:var(--green);font-size:11px"></span></div>
            <div style="display:flex;gap:7px">
              <button class="btn btn-ghost btn-sm" onclick="csvReset('bolge')">âœ• Ä°ptal</button>
              <button class="btn btn-primary btn-sm" onclick="csvSave('bolge')">âœ“ Hafta ProgramÄ±na Ekle</button>
            </div>
          </div>
          <div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Tarih</th><th>Salon</th><th>Saat</th><th>A TakÄ±mÄ±</th><th>B TakÄ±mÄ±</th><th>Kategori</th><th>Grup</th><th>1. Hakem</th><th>2. Hakem</th><th>RolÃ¼m</th></tr></thead><tbody id="csv-bolge-body"></tbody></table></div>
        </div>
      </div>
      <div class="card"><div class="card-title">ğŸ“š YÃ¼klenen Hafta GeÃ§miÅŸi</div><div id="csv-bolge-history"></div></div>
    </div>

    <!-- â”€â”€ OKUL â”€â”€ -->
    <div id="csvcat-okul" style="display:none">
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px">ğŸ« Okul Ä°l ve Ä°lÃ§e CSV YÃ¼kle</div>
            <div style="font-size:11px;color:var(--muted);margin-top:3px;font-family:'DM Mono',monospace">TARÄ°H Â· SAAT Â· SALON Â· ORGANÄ°ZASYON Â· GRUP Â· HAKEM Â· HAKEM</div>
          </div>
          <div style="align-self:flex-end">
            <button class="btn btn-green" onclick="document.getElementById('csv-okul-input').click()">ğŸ“‚ Dosya SeÃ§</button>
            <input type="file" id="csv-okul-input" accept=".csv,.tsv,.txt" style="display:none" onchange="handleCsv(event,'okul')">
          </div>
        </div>
        <div class="csv-drop" onclick="document.getElementById('csv-okul-input').click()"
          ondragover="event.preventDefault();this.style.borderColor='var(--green)';this.style.background='rgba(34,197,94,.05)'"
          ondragleave="this.style.borderColor='var(--border)';this.style.background=''"
          ondrop="event.preventDefault();this.style.borderColor='var(--border)';this.style.background='';handleCsv({target:{files:event.dataTransfer.files}},'okul')">
          <div style="font-size:30px;opacity:.35;margin-bottom:8px">ğŸ«</div>
          <div style="font-size:13px;font-weight:600;color:var(--muted2)">SÃ¼rÃ¼kle & bÄ±rak veya tÄ±kla</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">.csv Â· .tsv Â· tab/virgÃ¼l/noktalÄ± virgÃ¼l ayrÄ±lmÄ±ÅŸ</div>
        </div>
        <div id="csv-okul-error" class="csv-err" style="display:none"></div>
        <div id="csv-okul-preview" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px">
            <div style="font-size:13px;font-weight:600">Ã–nizleme â€” <span id="csv-okul-cnt" style="color:var(--green)">0</span> maÃ§ &nbsp;<span id="csv-okul-mine" style="color:var(--green);font-size:11px"></span></div>
            <div style="display:flex;gap:7px">
              <button class="btn btn-ghost btn-sm" onclick="csvReset('okul')">âœ• Ä°ptal</button>
              <button class="btn btn-green btn-sm" onclick="csvSave('okul')">âœ“ Okul ProgramÄ±na Ekle</button>
            </div>
          </div>
          <div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Tarih</th><th>Saat</th><th>Salon</th><th>Organizasyon</th><th>Grup</th><th>1. Hakem</th><th>2. Hakem</th><th>RolÃ¼m</th></tr></thead><tbody id="csv-okul-body"></tbody></table></div>
        </div>
      </div>
      <div class="card"><div class="card-title">ğŸ“š YÃ¼klenen Okul ProgramlarÄ±</div><div id="csv-okul-history"></div></div>
    </div>

    <!-- â”€â”€ Ã–ZEL â”€â”€ -->
    <div id="csvcat-ozel" style="display:none">
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px">
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:15px">ğŸ† Ã–zel Lig & Ãœniversite CSV YÃ¼kle</div>
            <div style="font-size:11px;color:var(--muted);margin-top:3px;font-family:'DM Mono',monospace">TARÄ°H Â· SALON Â· SAAT Â· A TAKIMI Â· B TAKIMI Â· ORGANÄ°ZASYON Â· KATEGORÄ° Â· HAKEM Â· HAKEM</div>
          </div>
          <div style="align-self:flex-end">
            <button class="btn" style="background:rgba(96,165,250,.15);color:#60a5fa;border:1px solid rgba(96,165,250,.3)" onclick="document.getElementById('csv-ozel-input').click()">ğŸ“‚ Dosya SeÃ§</button>
            <input type="file" id="csv-ozel-input" accept=".csv,.tsv,.txt" style="display:none" onchange="handleCsv(event,'ozel')">
          </div>
        </div>
        <div class="csv-drop" onclick="document.getElementById('csv-ozel-input').click()"
          ondragover="event.preventDefault();this.style.borderColor='#60a5fa';this.style.background='rgba(96,165,250,.05)'"
          ondragleave="this.style.borderColor='var(--border)';this.style.background=''"
          ondrop="event.preventDefault();this.style.borderColor='var(--border)';this.style.background='';handleCsv({target:{files:event.dataTransfer.files}},'ozel')">
          <div style="font-size:30px;opacity:.35;margin-bottom:8px">ğŸ†</div>
          <div style="font-size:13px;font-weight:600;color:var(--muted2)">SÃ¼rÃ¼kle & bÄ±rak veya tÄ±kla</div>
          <div style="font-size:10px;color:var(--muted);margin-top:4px">.csv Â· .tsv Â· tab/virgÃ¼l/noktalÄ± virgÃ¼l ayrÄ±lmÄ±ÅŸ</div>
        </div>
        <div id="csv-ozel-error" class="csv-err" style="display:none"></div>
        <div id="csv-ozel-preview" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 8px">
            <div style="font-size:13px;font-weight:600">Ã–nizleme â€” <span id="csv-ozel-cnt" style="color:#60a5fa">0</span> maÃ§ &nbsp;<span id="csv-ozel-mine" style="color:var(--green);font-size:11px"></span></div>
            <div style="display:flex;gap:7px">
              <button class="btn btn-ghost btn-sm" onclick="csvReset('ozel')">âœ• Ä°ptal</button>
              <button class="btn btn-sm" style="background:rgba(96,165,250,.2);color:#60a5fa;border:1px solid rgba(96,165,250,.3)" onclick="csvSave('ozel')">âœ“ Ã–zel Lig ProgramÄ±na Ekle</button>
            </div>
          </div>
          <div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Tarih</th><th>Salon</th><th>Saat</th><th>A TakÄ±mÄ±</th><th>B TakÄ±mÄ±</th><th>Organizasyon</th><th>Kategori</th><th>1. Hakem</th><th>2. Hakem</th><th>RolÃ¼m</th></tr></thead><tbody id="csv-ozel-body"></tbody></table></div>
        </div>
      </div>
      <div class="card"><div class="card-title">ğŸ“š YÃ¼klenen Ã–zel Lig ProgramlarÄ±</div><div id="csv-ozel-history"></div></div>
    </div>

  </div>

  <!-- Ã–zel -->
  <div id="progtab-ozel" style="display:none">
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div class="fg" style="flex:1;min-width:160px"><label>Ara</label><input type="text" id="pz-search" placeholder="Salon veya organizasyon..." oninput="renderOzel()"></div>
        <div style="align-self:flex-end;padding-bottom:2px"><span class="badge b-blue" id="pz-count">0 maÃ§</span></div>
      </div>
    </div>
    <div class="card" style="overflow-x:auto">
      <table class="tbl"><thead><tr><th>Tarih</th><th>Salon</th><th>Saat</th><th>A TakÄ±mÄ±</th><th>B TakÄ±mÄ±</th><th>Organizasyon</th><th>1. Hakem</th><th>2. Hakem</th><th>RolÃ¼m</th></tr></thead>
      <tbody id="ozel-body"></tbody></table>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div id="page-profile" class="page">
  <div class="ph"><div><div class="pt">Profil <span>AyarlarÄ±</span></div><div class="ps">Hesap bilgileriniz ve tercihler</div></div></div>
  <div class="two-col" style="max-width:800px">
    <div class="card">
      <div class="card-title">ğŸ‘¤ Hesap Bilgileri</div>
      <div id="profile-info" style="margin-bottom:20px"></div>
      <div class="card-title" style="margin-top:16px">âœï¸ Hakem AdÄ±nÄ± GÃ¼ncelle</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px">Programlarda gÃ¶rÃ¼ndÃ¼ÄŸÃ¼ ÅŸekilde bÃ¼yÃ¼k harfle yaz</div>
      <input class="login-input" id="profile-ref-name" type="text" placeholder="AD SOYAD" maxlength="60"
        oninput="this.value=this.value.toUpperCase()"
        style="background:var(--surf2);font-size:14px;margin-bottom:10px">
      <div style="display:flex;gap:9px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="updateRefName()">âœ“ Kaydet</button>
        <button class="btn btn-danger" onclick="signOutUser()">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">â„¹ï¸ Filtreleme NasÄ±l Ã‡alÄ±ÅŸÄ±r?</div>
      <div style="font-size:12px;color:var(--muted2);line-height:1.8">
        <p style="margin-bottom:8px">GirdiÄŸiniz <strong style="color:var(--text)">Hakem AdÄ±</strong>, tÃ¼m program CSV dosyalarÄ±ndaki <em>1. Hakem</em> ve <em>2. Hakem</em> sÃ¼tunlarÄ±nda aranÄ±r.</p>
        <p style="margin-bottom:8px">Sadece sizin adÄ±nÄ±zÄ±n geÃ§tiÄŸi maÃ§lar gÃ¶sterilir, diÄŸerleri gizlenir.</p>
        <p style="margin-bottom:8px">MaÃ§ eklerken Firestore veritabanÄ±na yalnÄ±zca sizin verileriniz kaydedilir.</p>
        <p style="color:var(--acc)">ğŸ’¡ Ä°pucu: AdÄ± tam doÄŸru girin â€” bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf farkÄ± gÃ¶zetilmez ama yazÄ±m hatasÄ± maÃ§larÄ± gizleyebilir.</p>
      </div>
      <div class="card-title" style="margin-top:16px">ğŸ“Š Ä°statistikler</div>
      <div id="profile-stats" style="font-size:13px;line-height:2"></div>
    </div>
  </div>
</div>

<!-- ADD -->
<div id="page-add" class="page">
  <div class="ph"><div><div class="pt">MaÃ§ <span>Ekle</span></div><div class="ps">Yeni atama bilgilerini girin</div></div></div>
  <div class="card">
    <div class="form-grid">
      <div class="fg" style="grid-column:1/-1"><label>Lig / Kategori</label>
        <select id="f-league" onchange="onLeague()">
          <option value="">â€” Lig seÃ§in â€”</option>
          <optgroup label="Erkekler U18/U16/U14"><option>U18EA</option><option>U18EB</option><option>U18EC</option><option>U16EA</option><option>U16EB</option><option>U16EC</option><option>U14EA</option><option>U14EB</option><option>U14EC</option><option>U14KB</option></optgroup>
          <optgroup label="Erkekler U12/U11/U10"><option>U12EA</option><option>U12EB</option><option>U12EC</option><option>U12KB</option><option>U11EA</option><option>U11EB</option><option>U11EC</option><option>U10EA</option><option>U10EB</option><option>U10EC</option></optgroup>
          <optgroup label="KÄ±zlar"><option>U18KA</option><option>U18KB</option><option>U16KA</option><option>U16KB</option><option>U14KA</option><option>U14KB</option><option>U12KA</option><option>U11KA</option></optgroup>
          <optgroup label="DiÄŸer"><option>BÃ¼yÃ¼k Erkekler</option><option>Ãœmit Erkekler</option><option>GeliÅŸim Ligi</option><option>BC Cup</option><option>Ä°lÃ§e / Okul</option><option>DiÄŸer</option></optgroup>
        </select>
      </div>
      <div class="fg sug-wrap"><label>Ev Sahibi TakÄ±m</label><input type="text" id="f-home" placeholder="TakÄ±m ara..." autocomplete="off" oninput="suggest('f-home','sl-home')"><div id="sl-home" class="sug-box"></div></div>
      <div class="fg sug-wrap"><label>Misafir TakÄ±m</label><input type="text" id="f-away" placeholder="TakÄ±m ara..." autocomplete="off" oninput="suggest('f-away','sl-away')"><div id="sl-away" class="sug-box"></div></div>
      <div class="fg"><label>Tarih</label><input type="date" id="f-date"></div>
      <div class="fg"><label>Saat</label><input type="time" id="f-time"></div>
      <div class="fg"><label>Lokasyon / Salon</label><input type="text" id="f-loc" placeholder="Salon adÄ±nÄ± girin"></div>
      <div class="fg"><label>Hakem RolÃ¼</label>
        <select id="f-role"><option>BaÅŸhakem</option><option>2. Hakem</option><option>3. Hakem</option><option>Masa GÃ¶revlisi</option></select>
      </div>
      <div class="fg"><label>MaÃ§ Ãœcreti (â‚º)</label><input type="number" id="f-fee" placeholder="0" min="0"></div>
      <div class="fg"><label>Ã–deme Durumu</label>
        <select id="f-payment"><option value="Bekleniyor">Bekleniyor</option><option value="Ã–dendi">Ã–dendi</option></select>
      </div>
      <div class="fg" style="grid-column:1/-1"><label>Notlar</label><input type="text" id="f-notes" placeholder="Ek bilgiler..."></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:9px;margin-top:18px;padding-top:16px;border-top:1px solid var(--border)">
      <button class="btn btn-ghost" onclick="clearForm()">Temizle</button>
      <button class="btn btn-primary" onclick="saveMatch()">âœ“ MaÃ§Ä± Kaydet</button>
    </div>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div id="page-notifications" class="page">
  <div class="ph"><div><div class="pt">Bildirim <span>AyarlarÄ±</span></div><div class="ps">Telefona native bildirim â€” backend yok, Ã¼cretsiz</div></div></div>
  <div class="two-col">

    <div class="card">
      <div class="card-title">ğŸ”” Push Bildirimleri</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:18px;line-height:1.7">
        MaÃ§ Ã¶ncesi telefonuna native bildirim gelir. UygulamayÄ± <strong style="color:var(--text)">Ana Ekrana Ekle</strong> (PWA) olarak yÃ¼kleyince arka planda da Ã§alÄ±ÅŸÄ±r.
      </div>

      <!-- Ä°zin Durumu -->
      <div id="pwa-perm-box" style="border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border)">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:13px;font-weight:600" id="perm-title">Bildirim Ä°zni</div>
            <div style="font-size:11px;color:var(--muted);margin-top:3px" id="perm-sub">Durum kontrol ediliyor...</div>
          </div>
          <button id="btn-req-perm" class="btn btn-primary" onclick="requestPushPermission()" style="display:none;font-size:12px">Ä°zin Ver</button>
        </div>
      </div>

      <!-- Test Bildirimi -->
      <div style="background:var(--surf2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:16px">
        <div style="font-size:12px;font-weight:600;color:var(--acc);margin-bottom:6px">ğŸ§ª Test Bildirimi</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px">Bildirimin gelip gelmediÄŸini kontrol et</div>
        <button class="btn btn-green" onclick="sendTestPush()" style="font-size:12px;padding:9px 16px">ğŸ“± Test Bildirimi GÃ¶nder</button>
      </div>

      <!-- Zamanlama -->
      <div class="card-title" style="margin-top:4px">â° Otomatik HatÄ±rlatmalar</div>
      <div class="ni-row">
        <div><div style="font-size:13px;font-weight:500">MaÃ§ gÃ¼nÃ¼ sabahÄ±</div><div style="font-size:11px;color:var(--muted)">08:00 â€” "BugÃ¼n maÃ§Ä±n var!"</div></div>
        <button id="tog-morning" class="toggle on" onclick="togglePushPref(this,'morning')"></button>
      </div>
      <div class="ni-row">
        <div><div style="font-size:13px;font-weight:500">1 gÃ¼n Ã¶ncesi</div><div style="font-size:11px;color:var(--muted)">AkÅŸam 20:00 â€” yarÄ±nki maÃ§ hatÄ±rlatmasÄ±</div></div>
        <button id="tog-day" class="toggle on" onclick="togglePushPref(this,'day')"></button>
      </div>
      <div class="ni-row">
        <div><div style="font-size:13px;font-weight:500">2 saat Ã¶ncesi</div><div style="font-size:11px;color:var(--muted)">MaÃ§tan 2 saat Ã¶nce son hatÄ±rlatma</div></div>
        <button id="tog-2h" class="toggle on" onclick="togglePushPref(this,'2h')"></button>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:16px">
      <!-- YaklaÅŸan Bildirimler -->
      <div class="card">
        <div class="card-title">ğŸ“… YaklaÅŸan MaÃ§lar</div>
        <div id="notif-q" style="font-size:12px;color:var(--muted2)">YÃ¼kleniyor...</div>
      </div>

      <!-- Manuel gÃ¶nder -->
      <div class="card">
        <div class="card-title">ğŸ“¤ Hemen Bildirim GÃ¶nder</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:12px">YaklaÅŸan maÃ§larÄ±ndan biri iÃ§in ÅŸimdi bildirim al</div>
        <select id="notif-match-sel" style="width:100%;background:var(--surf2);border:1px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text);font-size:12px;margin-bottom:10px;outline:none">
          <option value="">â€” MaÃ§ seÃ§ â€”</option>
        </select>
        <button class="btn btn-primary" onclick="sendMatchPush()" style="width:100%;justify-content:center;font-size:12px">ğŸ”” Bildirim Al</button>
      </div>

      <!-- PWA kurulum ipucu -->
      <div class="card" id="pwa-install-card">
        <div class="card-title">ğŸ“² Ana Ekrana Ekle</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.6">
          Arka planda bildirim alabilmek iÃ§in uygulamayÄ± PWA olarak yÃ¼kle:<br><br>
          <strong style="color:var(--text)">iPhone:</strong> Safari â†’ PaylaÅŸ â†’ Ana Ekrana Ekle<br>
          <strong style="color:var(--text)">Android:</strong> Chrome â†’ â‹® â†’ UygulamayÄ± YÃ¼kle
        </div>
        <button id="btn-pwa-install" class="btn btn-primary" style="font-size:12px;display:none" onclick="pwaTriggerInstall()">â¬‡ï¸ YÃ¼kle</button>
      </div>
    </div>
  </div>
</div>

</main>

<!-- EDIT MODAL -->
<div class="modal-bg" id="edit-modal">
  <div class="modal">
    <div class="modal-title">âœï¸ MaÃ§Ä± DÃ¼zenle</div>
    <div class="modal-sub" id="edit-sub"></div>
    <div class="form-grid">
      <div class="fg"><label>Ãœcret (â‚º)</label><input type="number" id="e-fee" min="0" placeholder="0"></div>
      <div class="fg"><label>Ã–deme Durumu</label><select id="e-payment"><option value="Bekleniyor">Bekleniyor</option><option value="Ã–dendi">Ã–dendi</option></select></div>
      <div class="fg"><label>Lig / Kategori</label><input type="text" id="e-league" placeholder="Kategori..."></div>
      <div class="fg"><label>Hakem RolÃ¼</label><select id="e-role"><option>BaÅŸhakem</option><option>2. Hakem</option><option>3. Hakem</option><option>Masa GÃ¶revlisi</option></select></div>
      <div class="fg" style="grid-column:1/-1"><label>Notlar</label><input type="text" id="e-notes" placeholder="Ek bilgi..."></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeEdit()">Ä°ptal</button>
      <button class="btn btn-danger btn-sm" onclick="deleteFromEdit()">ğŸ—‘ Sil</button>
      <button class="btn btn-primary" onclick="saveEdit()">âœ“ Kaydet</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script type="module">
(async function() {
try {

// â”€â”€â”€ SAFARI-SAFE localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LS = (() => {
  try { localStorage.setItem('__t','1'); localStorage.removeItem('__t'); return localStorage; }
  catch(e) {
    const _m = {};
    return { getItem: k=>_m[k]??null, setItem:(k,v)=>{_m[k]=String(v);}, removeItem: k=>delete _m[k] };
  }
})();
// Patch global localStorage references to use safe wrapper
// (we shadow it locally â€” all code below uses LS.getItem / LS.setItem directly where possible)

// â”€â”€â”€ FIREBASE IMPORT mit Safari-Retry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FBCDN = "https://www.gstatic.com/firebasejs/11.0.0/";
let initializeApp, getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where;
let getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut, getDoc, setDoc;
let _fbOk = false;
for (let attempt = 0; attempt < 3; attempt++) {
  try {
    ({ initializeApp } = await import(FBCDN+"firebase-app.js"));
    ({ getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, getDoc, setDoc } = await import(FBCDN+"firebase-firestore.js"));
    ({ getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged, signOut } = await import(FBCDN+"firebase-auth.js"));
    _fbOk = true;
    break;
  } catch(e) {
    if (attempt < 2) await new Promise(r => setTimeout(r, 800 * (attempt+1)));
    else throw e;
  }
}

const FB = {
  apiKey:"AIzaSyAy48pfk2xQeJ2Udwi5C-Y3Z7K1jV8DLoU",
  authDomain:"reftrack-df4ac.firebaseapp.com",
  projectId:"reftrack-df4ac",
  storageBucket:"reftrack-df4ac.firebasestorage.app",
  messagingSenderId:"907546777250",
  appId:"1:907546777250:web:44be03dd4f254cd4f5a9fb"
};

// Fix: Use Firebase's own auth domain for popup (avoids Vercel COOP/redirect issues)
const app = initializeApp(FB);
const db = getFirestore(app);
const auth = getAuth(app);

// Handle redirect result â€” must be awaited before onAuthStateChanged fires
try {
  await getRedirectResult(auth);
} catch(e) {
  if (e.code !== 'auth/no-auth-event') {
    const errEl = document.getElementById('login-error');
    if(errEl){ errEl.style.display=''; errEl.textContent='GiriÅŸ hatasÄ±: '+e.message; }
    document.getElementById('loading').style.display='none';
    document.getElementById('login-screen').style.display='flex';
  }
}

// â”€â”€â”€ CURRENT USER STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null; // { uid, email, displayName, refName, photoURL }
let col = null; // per-user collection
let _unsubMatches = null;

// â”€â”€â”€ AUTH FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.signInWithGoogle = async function() {
  const errEl = document.getElementById('login-error');
  errEl.style.display='none';
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    // Try popup first, fall back to redirect
    try {
      await signInWithPopup(auth, provider);
    } catch(popupErr) {
      if (popupErr.code === 'auth/popup-blocked' || popupErr.code === 'auth/popup-closed-by-user') {
        await signInWithRedirect(auth, provider);
      } else {
        throw popupErr;
      }
    }
  } catch(e) {
    errEl.style.display='';
    errEl.textContent = 'GiriÅŸ hatasÄ±: ' + e.message;
  }
};

window.signOutUser = async function() {
  if (!confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) return;
  if (_unsubMatches) { _unsubMatches(); _unsubMatches = null; }
  matches = [];
  currentUser = null;
  col = null;
  await signOut(auth);
  showLoginScreen();
};

window.validateRefNameInput = function(input) {
  const val = input.value.trim();
  const check = document.getElementById('ref-name-check');
  if (check) check.style.display = val.length >= 3 ? '' : 'none';
};

window.confirmRefName = async function() {
  const name = (document.getElementById('login-ref-name').value||'').trim().toUpperCase();
  if (!name || name.length < 2) { toast('LÃ¼tfen geÃ§erli bir ad girin','err'); return; }
  await saveRefName(name);
};

window.updateRefName = async function() {
  const name = (document.getElementById('profile-ref-name').value||'').trim().toUpperCase();
  if (!name || name.length < 2) { toast('LÃ¼tfen geÃ§erli bir ad girin','err'); return; }
  await saveRefName(name);
  toast('âœ“ Hakem adÄ± gÃ¼ncellendi! Sayfa yenilenecek...','ok');
  setTimeout(()=>window.location.reload(),1500);
};

async function saveRefName(name) {
  if (!auth.currentUser) return;
  const uid = auth.currentUser.uid;
  await setDoc(doc(db,'users',uid),{
    refName: name,
    displayName: auth.currentUser.displayName||'',
    email: auth.currentUser.email||'',
    updatedAt: new Date().toISOString()
  },{merge:true});
  currentUser.refName = name;
}

async function loadUserProfile(firebaseUser) {
  const uid = firebaseUser.uid;
  const snap = await getDoc(doc(db,'users',uid));
  const data = snap.exists() ? snap.data() : {};
  currentUser = {
    uid,
    email: firebaseUser.email||'',
    displayName: firebaseUser.displayName||'',
    refName: data.refName||'',
    photoURL: firebaseUser.photoURL||''
  };
  return currentUser;
}

function showLoginScreen() {
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('login-step-google').style.display='';
  document.getElementById('login-step-name').style.display='none';
  document.getElementById('loading').style.display='none';
  // Hide main app
  document.querySelector('.sidebar').classList.add('app-hidden');
  document.querySelector('.main').classList.add('app-hidden');
  document.getElementById('sync').classList.add('app-hidden');
}

function showNameStep(user) {
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('login-step-google').style.display='none';
  document.getElementById('login-step-name').style.display='';
  const letter = (user.displayName||user.email||'?').charAt(0).toUpperCase();
  document.getElementById('login-av-letter').textContent=letter;
  document.getElementById('login-display-name').textContent=user.displayName||user.email;
  document.getElementById('login-email').textContent=user.email;
  document.getElementById('login-ref-name').value='';
}

async function initUserApp(user) {
  // Set up per-user matches collection
  col = collection(db,'users',user.uid,'matches');

  // Update sidebar
  const letter = (user.displayName||user.email||'?').charAt(0).toUpperCase();
  document.getElementById('sidebar-av').textContent=letter;
  document.getElementById('sidebar-name').textContent=user.displayName||user.email||'â€”';
  document.getElementById('sidebar-role').textContent=user.refName||'Hakem';

  // Update dashboard hero greeting
  const nameEl=document.getElementById('dash-name-span');
  if(nameEl) nameEl.textContent=user.refName||(user.displayName||'Hakem');
  const refBadge=document.getElementById('dash-refname-badge');
  if(refBadge) refBadge.textContent=(user.refName||'Hakem').toUpperCase();
  const progSub=document.getElementById('prog-page-sub');
  if(progSub) progSub.textContent='TÃ¼m kategoriler â€” sadece '+( user.refName||'senin')+' maÃ§larÄ±';
  const progName=document.getElementById('prog-active-name');
  if(progName) progName.textContent=(user.refName||'â€”');

  // Update profile page
  renderProfile();

  // Hide login, show app
  document.getElementById('login-screen').style.display='none';
  document.querySelector('.sidebar').classList.remove('app-hidden');
  document.querySelector('.main').classList.remove('app-hidden');
  document.getElementById('sync').classList.remove('app-hidden');
  document.getElementById('loading').style.display='none';

  // Load matches realtime
  startMatchesListener();

  // Init greeting
  const now=new Date();
  document.getElementById('today-date').textContent=now.toLocaleDateString('tr-TR',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const hr=now.getHours();
  const greet=hr<12?'GÃ¼naydÄ±n':hr<17?'Ä°yi gÃ¼nler':hr<21?'Ä°yi akÅŸamlar':'Ä°yi geceler';
  const gEl=document.getElementById('dash-greeting');
  if(gEl) gEl.textContent=greet;
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  loadCsvFromStorage();
  setTimeout(()=>{ renderHafta(); renderOkul(); renderOzel(); },300);
}

function startMatchesListener() {
  if (_unsubMatches) { _unsubMatches(); _unsubMatches=null; }
  const q = query(col, orderBy('date','asc'));
  _unsubMatches = onSnapshot(q, snap=>{
    matches=snap.docs.map(d=>({id:d.id,...d.data()}));
    setSync('');
    renderAll();
    if(_firstLoad){_firstLoad=false;setTimeout(autoSync,1500);}
  }, err=>{
    setSync('error');
    toast('Firebase hatasÄ±: '+err.message,'err');
  });
}

function renderProfile() {
  if (!currentUser) return;
  const el = document.getElementById('profile-info');
  if (el) {
    const letter=(currentUser.displayName||currentUser.email||'?').charAt(0).toUpperCase();
    el.innerHTML=`<div style="display:flex;align-items:center;gap:14px;padding:14px;background:var(--surf2);border-radius:10px;border:1px solid var(--border)">
      <div style="width:48px;height:48px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#fff;flex-shrink:0">${letter}</div>
      <div>
        <div style="font-size:14px;font-weight:600">${currentUser.displayName||'â€”'}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px">${currentUser.email}</div>
        <div style="font-size:11px;color:var(--acc);margin-top:3px;font-family:'DM Mono',monospace">ğŸ€ ${currentUser.refName||'Hakem adÄ± ayarlanmamÄ±ÅŸ'}</div>
      </div>
    </div>`;
  }
  const inp = document.getElementById('profile-ref-name');
  if (inp) inp.value = currentUser.refName||'';
  const statsEl = document.getElementById('profile-stats');
  if (statsEl) {
    const total=matches.length;
    const upcoming=matches.filter(m=>!isPast(m)).length;
    const earned=matches.reduce((s,m)=>s+(m.fee||0),0);
    statsEl.innerHTML=`<div>ğŸ“‹ Toplam KayÄ±tlÄ± MaÃ§: <strong style="color:var(--acc)">${total}</strong></div>
      <div>ğŸ“… Gelecek MaÃ§: <strong style="color:var(--blue)">${upcoming}</strong></div>
      <div>ğŸ’° Toplam KazanÃ§: <strong style="color:var(--green)">â‚º${earned.toLocaleString('tr-TR')}</strong></div>`;
  }
}

// â”€â”€â”€ AUTH STATE OBSERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async (firebaseUser) => {
  if (firebaseUser) {
    // User is signed in
    document.getElementById('loading').style.display='flex';
    document.getElementById('login-screen').style.display='none';
    try {
      const user = await loadUserProfile(firebaseUser);
      if (!user.refName) {
        // Need to set referee name
        document.getElementById('loading').style.display='none';
        showNameStep(user);
      } else {
        await initUserApp(user);
      }
    } catch(e) {
      document.getElementById('loading').style.display='none';
      showLoginScreen();
      toast('Profil yÃ¼klenemedi: '+e.message,'err');
    }
  } else {
    // Not signed in
    showLoginScreen();
  }
});



// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let matches = [];
let _editId = null;
let _firstLoad = true;
let settings = JSON.parse(LS.getItem('rt_settings')||'{"email":"","pushNotifs":{"morning":true,"day":true,"2h":true},"notifSent":{}}');

// â”€â”€â”€ PROGRAM VERÄ°SÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ DYNAMIC REF NAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMyName() { return (currentUser && currentUser.refName) ? currentUser.refName.toUpperCase() : ''; }

// Legacy compat (kept for display purposes only)
const MY = "ÅEMSETTÄ°N KEMAL ATAK";

const HAFTA = {
  12:[{tarih:"24 KasÄ±m 2025 Pazartesi",salon:"CAFERAÄA S.S",saat:"17:30",ev:"Ä°STANBUL YILDIZLARI",dep:"BEYKENT BASKETBOL",kat:"U14KB",grup:"B GRUBU",h1:"ERTUÄRUL TURAN TOPAL",h2:"ÅEMSETTÄ°N KEMAL ATAK"}],
  14:[
    {tarih:"8 AralÄ±k 2025 Pazartesi",salon:"KURTKÃ–Y S.S",saat:"17:00",ev:"11 ARTHLETIC S.K",dep:"Ä°STANBUL Ã‡EKMEKÃ–Y SPORTÄ°F",kat:"U14EC",grup:"5.GRUP",h1:"ERTUÄRUL TURAN TOPAL",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"10 AralÄ±k 2025 Ã‡arÅŸamba",salon:"KURTKÃ–Y S.S",saat:"17:00",ev:"ANKA BASKETBOL AKADEMÄ° (B)",dep:"DEV ADIM Ä°STANBUL",kat:"U14EC",grup:"3.GRUP",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"13 AralÄ±k 2025 Cumartesi",salon:"Ã‡EKMEKÃ–Y SPOR KOMPLEKSÄ°",saat:"20:00",ev:"DEV ADIM S.K",dep:"MVP SPOR KULÃœBÃœ (B)",kat:"U14EC",grup:"4.GRUP",h1:"MUHAMMET GÃ–NÃœLTAÅ",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  15:[
    {tarih:"17 AralÄ±k 2025 Ã‡arÅŸamba",salon:"MALTEPE MÃœZAHÄ°R SÄ°LLE S.S",saat:"18:30",ev:"POTANIN KARTALLARI S.K",dep:"SPOR VÄ°ZYON",kat:"U14EC",grup:"1.GRUP",h1:"BERFÄ°N Ã–NLÃœ",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"21 AralÄ±k 2025 Pazar",salon:"Ã‡EKMEKÃ–Y SPOR KOMPLEKSÄ°",saat:"18:30",ev:"ANADOLU MARMARA S.K",dep:"ENERJÄ° MOTÄ°VASYON ADRENALÄ°N",kat:"U16EC",grup:"5.GRUP",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  16:[
    {tarih:"22 AralÄ±k 2025 Pazartesi",salon:"KURTKÃ–Y S.S",saat:"17:00",ev:"ENERJÄ° MOTÄ°VASYON ADRENALÄ°N",dep:"BEYKOS SPOR KULÃœBÃœ",kat:"U12EC",grup:"ASYA C GRUBU",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"22 AralÄ±k 2025 Pazartesi",salon:"KURTKÃ–Y S.S",saat:"18:30",ev:"DUDULLU OSB (B)",dep:"POTANIN KARTALLARI",kat:"U12EC",grup:"ASYA B GRUBU",h1:"ABDULMECÄ°D GÃœMÃœÅ",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"26 AralÄ±k 2025 Cuma",salon:"CAFERAÄA S.S",saat:"17:30",ev:"ATAÅEHÄ°R KARTALLARI",dep:"TÄ°TAN AKADEMÄ° (A)",kat:"U12EC",grup:"ASYA F GRUBU",h1:"DUYGU DÄ°NDAR",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  17:[
    {tarih:"30 AralÄ±k 2025 SalÄ±",salon:"YAKACIK Ä°TO S.S",saat:"18:30",ev:"METROPOL BASKET",dep:"DEV ATAÅEHÄ°R (B)",kat:"U12EC",grup:"ASYA B GR.",h1:"UGUR YÃœKSEL",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"2 Ocak 2026 Cuma",salon:"KURTKÃ–Y S.S",saat:"20:00",ev:"ADA YILDIZLARI",dep:"Ä°STANBUL DEV S.K",kat:"U11EC",grup:"ASYA C GR.",h1:"ABDULMECÄ°D GÃœMÃœÅ",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  22:[
    {tarih:"7 Åubat 2026 Cumartesi",salon:"ÃœNALAN MUHSÄ°N YAZICIOÄLU S.S",saat:"16:00",ev:"EVOLOG DAÃ‡KA ÅERÄ°FALÄ°",dep:"USA BASKETBOL",kat:"U12KB",grup:"ASYA GRUBU",h1:"AHMET KETENCÄ°",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"7 Åubat 2026 Cumartesi",salon:"ÃœNALAN MUHSÄ°N YAZICIOÄLU S.S",saat:"17:30",ev:"ANKA ANADOLU (A)",dep:"2014 MALTEPE",kat:"U11EC",grup:"ASYA G GR.",h1:"AHMET KETENCÄ°",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"7 Åubat 2026 Cumartesi",salon:"ÃœNALAN MUHSÄ°N YAZICIOÄLU S.S",saat:"19:00",ev:"TÄ°TAN AKADEMÄ°",dep:"FMV IÅIK S.K",kat:"U10EB",grup:"A GRUBU",h1:"MUHAMMET ARÄ°F SÄ°LAHLI",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"8 Åubat 2026 Pazar",salon:"CAFERAÄA S.S",saat:"19:30",ev:"TÄ°TAN AKADEMÄ° (B)",dep:"TENÄ°S ESKRÄ°M DAÄCILIK",kat:"U12EA",grup:"B GRUBU",h1:"AHMET KETENCÄ°",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  23:[
    {tarih:"15 Åubat 2026 Pazar",salon:"ÃœNALAN MUHSÄ°N YAZICIOÄLU S.S",saat:"17:30",ev:"DIAMOND&ONE BASKETBOL AKD.",dep:"KARTAL YILDIZLARI",kat:"U11EC",grup:"ASYA F GR.",h1:"ORHAN SAMET YAYLA",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"15 Åubat 2026 Pazar",salon:"ÃœNALAN MUHSÄ°N YAZICIOÄLU S.S",saat:"19:00",ev:"DUDULLU OSB",dep:"CAAN S.K",kat:"U11EC",grup:"ASYA G GR.",h1:"BERFÄ°N Ã–NLÃœ",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  24:[
    {tarih:"17 Åubat 2026 SalÄ±",salon:"YAKACIK Ä°TO S.S",saat:"18:30",ev:"Ä°STANBUL Ã‡EKMEKÃ–Y SPORTÄ°F",dep:"DEV SPOR",kat:"U14EC",grup:"5.GRUP",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"17 Åubat 2026 SalÄ±",salon:"YAKACIK Ä°TO S.S",saat:"20:00",ev:"ÅÄ°LESPOR S.K",dep:"DEV ADIM Ä°STANBUL",kat:"U14EC",grup:"3.GRUP",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"21 Åubat 2026 Cumartesi",salon:"ÃœNALAN MUHSÄ°N YAZICIOÄLU S.S",saat:"19:00",ev:"KARÅIYAKA DOÄAN",dep:"KIZILTOPRAK 2004 (A)",kat:"U14EC",grup:"9.GRUP",h1:"ABDULMECÄ°D GÃœMÃœÅ",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  25:[
    {tarih:"25 Åubat 2026 Ã‡arÅŸamba",salon:"KURTKÃ–Y S.S",saat:"18:30",ev:"TAN SPOR KULÃœBÃœ",dep:"GÄ°RÄ°ÅÄ°M S.K. (A)",kat:"U16EB",grup:"H GRUBU",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ]
};

const OKUL = {
  current:[
    {tarih:"24 Åubat 2026 SalÄ±",saat:"09:30",salon:"KARTAL MÄ°LLÄ° EÄÄ°TÄ°M VAKFI O.O. S.S.",org:"KARTAL Ä°LÃ‡E",grup:"YE",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"24 Åubat 2026 SalÄ±",saat:"10:30",salon:"KARTAL MÄ°LLÄ° EÄÄ°TÄ°M VAKFI O.O. S.S.",org:"KARTAL Ä°LÃ‡E",grup:"YE",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"24 Åubat 2026 SalÄ±",saat:"11:30",salon:"KARTAL MÄ°LLÄ° EÄÄ°TÄ°M VAKFI O.O. S.S.",org:"KARTAL Ä°LÃ‡E",grup:"KK",h1:"RECEP DAÄDELEN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"26 Åubat 2026 PerÅŸembe",saat:"09:30",salon:"ÅEHÄ°T ÅÃœKRÃœ BAYRAKÃ‡I Ä°LKOKULU",org:"KARTAL Ä°LÃ‡E",grup:"ME",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"26 Åubat 2026 PerÅŸembe",saat:"10:15",salon:"ÅEHÄ°T ÅÃœKRÃœ BAYRAKÃ‡I Ä°LKOKULU",org:"KARTAL Ä°LÃ‡E",grup:"ME",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"26 Åubat 2026 PerÅŸembe",saat:"11:00",salon:"ÅEHÄ°T ÅÃœKRÃœ BAYRAKÃ‡I Ä°LKOKULU",org:"KARTAL Ä°LÃ‡E",grup:"ME",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ],
  arsiv:[
    {tarih:"8 AralÄ±k 2025 Pazartesi",saat:"09:30",salon:"HABÄ°RE YAHÅÄ° ANADOLU LÄ°SESÄ°",org:"ATAÅEHÄ°R Ä°LÃ‡E",grup:"KE",h1:"DUYGU DÄ°NDAR",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"8 AralÄ±k 2025 Pazartesi",saat:"10:30",salon:"HABÄ°RE YAHÅÄ° ANADOLU LÄ°SESÄ°",org:"ATAÅEHÄ°R Ä°LÃ‡E",grup:"KE",h1:"DUYGU DÄ°NDAR",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"8 AralÄ±k 2025 Pazartesi",saat:"11:30",salon:"HABÄ°RE YAHÅÄ° ANADOLU LÄ°SESÄ°",org:"ATAÅEHÄ°R Ä°LÃ‡E",grup:"KE",h1:"DUYGU DÄ°NDAR",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"8 AralÄ±k 2025 Pazartesi",saat:"12:30",salon:"HABÄ°RE YAHÅÄ° ANADOLU LÄ°SESÄ°",org:"ATAÅEHÄ°R Ä°LÃ‡E",grup:"KE",h1:"DUYGU DÄ°NDAR",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"8 AralÄ±k 2025 Pazartesi",saat:"13:30",salon:"HABÄ°RE YAHÅÄ° ANADOLU LÄ°SESÄ°",org:"ATAÅEHÄ°R Ä°LÃ‡E",grup:"KE",h1:"DUYGU DÄ°NDAR",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"23 AralÄ±k 2025 SalÄ±",saat:"10:00",salon:"HAYDARPAÅA MTAL",org:"ÃœSKÃœDAR Ä°LÃ‡E 3X3",grup:"Y.E.K",h1:"ÅEMSETTÄ°N KEMAL ATAK",h2:""},
    {tarih:"25 AralÄ±k 2025 PerÅŸembe",saat:"10:00",salon:"HAYDARPAÅA MTAL",org:"ÃœSKÃœDAR Ä°LÃ‡E 3X3",grup:"Y.E.K",h1:"ÅEMSETTÄ°N KEMAL ATAK",h2:""},
    {tarih:"10 Åubat 2026 SalÄ±",saat:"10:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"10 Åubat 2026 SalÄ±",saat:"11:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"10 Åubat 2026 SalÄ±",saat:"12:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"10 Åubat 2026 SalÄ±",saat:"13:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"10 Åubat 2026 SalÄ±",saat:"14:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"12 Åubat 2026 PerÅŸembe",saat:"10:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"12 Åubat 2026 PerÅŸembe",saat:"11:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"12 Åubat 2026 PerÅŸembe",saat:"12:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"12 Åubat 2026 PerÅŸembe",saat:"13:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"12 Åubat 2026 PerÅŸembe",saat:"14:00",salon:"BEYKOZ ANADOLU Ä°MAM HATÄ°P LÄ°SESÄ° SPOR SALONU",org:"BEYKOZ Ä°LÃ‡E",grup:"GRUP",h1:"ERTAN CAN BOSTAN",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"16 Åubat 2026 Pazartesi",saat:"09:30",salon:"MÄ°LLÄ° EÄÄ°TÄ°M VAKFI ORTAOKULU S.S.",org:"KARTAL Ä°LÃ‡E",grup:"KE",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"16 Åubat 2026 Pazartesi",saat:"10:30",salon:"MÄ°LLÄ° EÄÄ°TÄ°M VAKFI ORTAOKULU S.S.",org:"KARTAL Ä°LÃ‡E",grup:"KE",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"16 Åubat 2026 Pazartesi",saat:"11:30",salon:"MÄ°LLÄ° EÄÄ°TÄ°M VAKFI ORTAOKULU S.S.",org:"KARTAL Ä°LÃ‡E",grup:"KE",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"16 Åubat 2026 Pazartesi",saat:"12:30",salon:"MÄ°LLÄ° EÄÄ°TÄ°M VAKFI ORTAOKULU S.S.",org:"KARTAL Ä°LÃ‡E",grup:"KE",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
    {tarih:"16 Åubat 2026 Pazartesi",saat:"13:30",salon:"MÄ°LLÄ° EÄÄ°TÄ°M VAKFI ORTAOKULU S.S.",org:"KARTAL Ä°LÃ‡E",grup:"KE",h1:"MURAT AMAÃ‡",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
  ]
};

const OZEL = [
  {tarih:"22 Åubat 2026 Pazar",salon:"ACIBADEM ÃœNÄ°VERSÄ°TESÄ° KEREM AYDINLAR KAMPÃœSÃœ S. S.",saat:"16:45",a:"",b:"",org:"GELÄ°ÅÄ°M LÄ°GÄ°",h1:"HARUN CANKIR",h2:"ÅEMSETTÄ°N KEMAL ATAK"},
  {tarih:"22 Åubat 2026 Pazar",salon:"ACIBADEM ÃœNÄ°VERSÄ°TESÄ° KEREM AYDINLAR KAMPÃœSÃœ S. S.",saat:"18:00",a:"",b:"",org:"GELÄ°ÅÄ°M LÄ°GÄ°",h1:"HARUN CANKIR",h2:"ÅEMSETTÄ°N KEMAL ATAK"}
];

const TEAMS = [
  'ANADOLU EFES','FENERBAHÃ‡E','GALATASARAy','BEÅÄ°KTAÅ','DARÃœÅÅAFAKA','TÄ°TAN AKADEMÄ°',
  'PAMUKSPOR GELÄ°ÅÄ°M','NOVA BASKET','Ä°STANBUL BBSK','ALLSTARS Ä°STANBUL','BOÄAZÄ°Ã‡Ä° AKADEMÄ°',
  'DEV ATAÅEHÄ°R','DEV ADIM Ä°STANBUL','ANKA BASKETBOL AKADEMÄ°','ANKA ANADOLU','EVOLOG DAÃ‡KA ÅERÄ°FALÄ°',
  'DUDULLU OSB','METROPOL BASKET','USA BASKETBOL','ADA YILDIZLARI','Ä°STANBUL YILDIZLARI',
  'BEYKENT BASKETBOL','KIZILTOPRAK 2004','KARÅIYAKA DOÄAN','ÅÄ°LESPOR S.K','ENERJÄ° MOTÄ°VASYON ADRENALÄ°N',
  'POTANIN KARTALLARI','SPOR VÄ°ZYON','ANADOLU MARMARA S.K','DEV SPOR','GÄ°RÄ°ÅÄ°M S.K.',
  'TAN SPOR KULÃœBÃœ','MVP SPOR KULÃœBÃœ','11 ARTHLETIC S.K','2014 MALTEPE','FMV IÅIK S.K',
  'CAAN S.K','KARTAL YILDIZLARI','DIAMOND&ONE BASKETBOL AKD.','ATAÅEHÄ°R KARTALLARI',
  'BEYKOS SPOR KULÃœBÃœ','TENÄ°S ESKRÄ°M DAÄCILIK','Ä°STANBUL Ã‡EKMEKÃ–Y SPORTÄ°F',
  'BAHÃ‡EÅEHÄ°R KOLEJÄ°','TEÅVÄ°KÄ°YE S.K','ESENLER YAVUZ SELÄ°M S.K.','FMV ERENKÃ–Y IÅIKSPOR'
];

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ ÃœCRET SABÄ°TLERÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FEES = {
  bolge: 748,    // Hafta ProgramlarÄ± / BÃ¶lge maÃ§Ä±
  okul:  320,    // Okul Ä°l ve Ä°lÃ§e
  gelisim: 1200, // Ã–zel Lig â€” GeliÅŸim Ligi
  ozel:  0,      // Ã–zel Lig â€” diÄŸer (manuel girilsin)
};

function guessFee(m) {
  const cat = guessCat(m);
  if (cat === 'okul') return FEES.okul;
  if (cat === 'bolge') return FEES.bolge;
  // ozel â†’ gelisim ligi mi kontrol et
  const lig = (m.league||'').toUpperCase();
  if (lig.includes('GELÄ°ÅÄ°M')) return FEES.gelisim;
  return 0; // diÄŸer Ã¶zel lig â€” manuel
}

const MONTHS = {Ocak:'01',Åubat:'02',Mart:'03',Nisan:'04',MayÄ±s:'05',Haziran:'06',Temmuz:'07',AÄŸustos:'08',EylÃ¼l:'09',Ekim:'10',KasÄ±m:'11',AralÄ±k:'12'};

function parseTarih(t) {
  const p = t.trim().split(' ');
  const d = p[0].padStart(2,'0');
  const m = MONTHS[p[1]] || '01';
  const y = (p[2] && p[2].length===4) ? p[2] : '2026';
  return `${y}-${m}-${d}`;
}

function isPast(m) {
  return new Date(m.date + 'T' + (m.time||'23:59')) < new Date();
}
function getUpcoming() { return matches.filter(m=>!isPast(m)).sort((a,b)=>a.date.localeCompare(b.date)); }
function getPast()     { return matches.filter(m=>isPast(m)).sort((a,b)=>b.date.localeCompare(a.date)); }

function fmtDate(d) {
  return new Date(d+'T12:00').toLocaleDateString('tr-TR',{day:'numeric',month:'short',year:'numeric'});
}
function timeLeft(m) {
  const diff = new Date(m.date+'T'+(m.time||'12:00')) - new Date();
  if (diff<=0) return 'â€”';
  const d=Math.floor(diff/86400000), h=Math.floor((diff%86400000)/3600000), mn=Math.floor((diff%3600000)/60000);
  if (d>0) return `${d}g ${h}s`;
  if (h>0) return `${h}s ${mn}d`;
  return `${mn}d`;
}

function myRole(h1,h2) {
  const me = getMyName(); if(!me) return 'â€”';
  if ((h1||'').toUpperCase().includes(me)) return 'BaÅŸhakem';
  if ((h2||'').toUpperCase().includes(me)) return '2. Hakem';
  return 'â€”';
}

function guessLig(m) {
  if (m.league && m.league.trim() && m.league!=='â€”') return m.league;
  const loc = (m.location||'').toUpperCase();
  const home = (m.home||'').toUpperCase();
  // hafta eÅŸleÅŸmesi
  for (const [wk,arr] of Object.entries(HAFTA)) {
    for (const h of arr) {
      if ((h.ev||'').toUpperCase()===home && parseTarih(h.tarih)===m.date) return h.kat+' â€” '+wk+'. Hafta';
    }
  }
  // okul eÅŸleÅŸmesi
  for (const src of ['current','arsiv']) {
    for (const h of OKUL[src]) {
      if (parseTarih(h.tarih)===m.date && (h.salon||'').toUpperCase()===loc) return h.org;
    }
  }
  // Ã¶zel lig
  for (const h of OZEL) {
    if (parseTarih(h.tarih)===m.date) return h.org;
  }
  return 'â€”';
}

function guessCat(m) {
  // Explicit category field takes priority
  if (m.category) return m.category;
  const lig = (m.league||'').toUpperCase();
  const loc = (m.location||'').toUpperCase();
  const notes = (m.notes||'').toUpperCase();
  if (notes.includes('Ã–ZEL LIG')||notes.includes('Ã–ZEL LÄ°G')||notes.includes('UNIVERSITE')||notes.includes('ÃœNÄ°VERSÄ°TE')) return 'ozel';
  if (notes.includes('OKUL')||notes.includes('Ä°LÃ‡E')||notes.includes('ILCE')) return 'okul';
  if (lig.includes('GELÄ°ÅÄ°M')||lig.includes('GELÄ°ÅÄ°M')||lig.includes('GELISIM')||lig.includes('BC CUP')||lig.includes('ÃœNÄ°VERSÄ°TE')||lig.includes('UNIVERSITE')||loc.includes('ÃœNÄ°VERSÄ°TE')||loc.includes('UNIVERSITE')||loc.includes('KAMPÃœS')||loc.includes('KAMPUS')) return 'ozel';
  if (lig.includes('Ä°LÃ‡E')||lig.includes('ILCE')||lig.includes('OKUL')||lig.includes('3X3')||loc.includes('LÄ°SESÄ°')||loc.includes('LISESI')||loc.includes('MTAL')||loc.includes('Ä°LKOKUL')||loc.includes('ILKOKUL')||loc.includes('ORTAOKUL')) return 'okul';
  return 'bolge';
}

// â”€â”€â”€ SYNC STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSync(s) {
  const dot=document.getElementById('sdot'), txt=document.getElementById('stxt');
  dot.className='sdot'+(s?' '+s:'');
  txt.textContent = s===''?'Senkronize':s==='syncing'?'Kaydediliyor...':'BaÄŸlantÄ± hatasÄ±';
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toast = function(msg,type) {
  const el=document.createElement('div');
  el.className='toast'+(type==='ok'?' ok':type==='err'?' err':'');
  el.textContent=msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(()=>el.remove(),3500);
};

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.go = function(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  // highlight nav
  document.querySelectorAll('.ni').forEach(n=>{
    const t=n.textContent.toLowerCase();
    if(id==='dashboard'&&t.includes('dashboard')) n.classList.add('active');
    else if(id==='upcoming'&&t.includes('gelecek')) n.classList.add('active');
    else if(id==='past'&&t.includes('geÃ§miÅŸ')) n.classList.add('active');
    else if(id==='finance'&&t.includes('Ã¼cret')) n.classList.add('active');
    else if(id==='program'&&t.includes('program')) n.classList.add('active');
    else if(id==='add'&&t.includes('ekle')) n.classList.add('active');
    else if(id==='notifications'&&t.includes('bildirim')) n.classList.add('active');
    else if(id==='profile'&&t.includes('profil')) n.classList.add('active');
  });
  renderAll();
};

// â”€â”€â”€ PROGRAM TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.progTab = function(tab) {
  ['hafta','okul','ozel','csv'].forEach(t=>{
    const el = document.getElementById('progtab-'+t);
    if(el) el.style.display = t===tab?'':'none';
    const btn = document.getElementById('ptab-'+t);
    if(btn) btn.classList.toggle('active', t===tab);
  });
  if(tab==='hafta') renderHafta();
  if(tab==='okul')  renderOkul();
  if(tab==='ozel')  renderOzel();
  if(tab==='csv')   renderCsvHistory();
};

// â”€â”€â”€ RENDER HAFTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.renderHafta = function() {
  const search = (document.getElementById('ph-search')?.value||'').toUpperCase();
  const wk = document.getElementById('ph-week')?.value||'';
  const mine = (document.getElementById('ph-mine')?.value||'mine')==='mine';
  const period = document.getElementById('ph-period')?.value||'all';
  const now = new Date();

  let data = wk==='' ? Object.values(HAFTA).flat() : (HAFTA[parseInt(wk)]||[]);
  if (mine) data = data.filter(m=>{const me=getMyName();return me&&(m.h1+m.h2).toUpperCase().includes(me);});
  if (search) data = data.filter(m=>(m.ev+m.dep+m.salon).toUpperCase().includes(search));
  if (period === 'past')   data = data.filter(m => new Date(parseTarih(m.tarih)+'T'+(m.saat||'23:59')) < now);
  if (period === 'future') data = data.filter(m => new Date(parseTarih(m.tarih)+'T'+(m.saat||'23:59')) >= now);

  // GeÃ§miÅŸ â†’ yeniden eskiye, Gelecek â†’ eskiden yeniye
  data = data.slice().sort((a,b)=>{
    const da = parseTarih(a.tarih)+' '+(a.saat||'');
    const db = parseTarih(b.tarih)+' '+(b.saat||'');
    return period === 'future' ? da.localeCompare(db) : db.localeCompare(da);
  });

  document.getElementById('ph-count').textContent = data.length+' maÃ§';
  window._hafta = data;
  const tb = document.getElementById('hafta-body');
  if (!data.length) { tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-ic">ğŸ”</div><div class="empty-tx">MaÃ§ bulunamadÄ±</div></div></td></tr>`; return; }
  tb.innerHTML = data.map((m,i)=>{
    const rol = myRole(m.h1,m.h2);
    const rolBadge = rol!=='â€”' ? `<span class="role-badge">${rol}</span>` : '<span style="color:var(--muted);font-size:10px">â€”</span>';
    const dateStr2 = parseTarih(m.tarih);
    const isFut = new Date(dateStr2+'T'+(m.saat||'23:59')) >= new Date();
    const btnStyle = isFut ? 'background:rgba(96,165,250,.15);color:#60a5fa;border:1px solid rgba(96,165,250,.3)' : 'background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.25)';
    const btnLabel = isFut ? 'ğŸ“… Gelecek' : 'âœ… GeÃ§miÅŸ';

    return `<tr style="background:rgba(249,115,22,.05)">
      <td style="font-size:11px;white-space:nowrap">${m.tarih}</td>
      <td style="font-size:11px">${m.salon}</td>
      <td><strong>${m.saat}</strong></td>
      <td><strong style="color:var(--acc)">ğŸ€ ${m.ev||'â€”'}</strong></td>
      <td style="font-size:12px">${m.dep||'â€”'}</td>
      <td><span class="badge b-orange" style="font-size:10px">${m.kat}</span></td>
      <td style="font-size:11px;color:var(--muted)">${m.grup}</td>
      <td>${rolBadge}</td>
      <td><button class="btn btn-sm" style="${btnStyle};font-size:11px;padding:4px 10px" onclick="haftaEkle(${i})">${btnLabel}</button></td>
    </tr>`;
  }).join('');
};

window.renderOkul = function() {
  const search = (document.getElementById('po-search')?.value||'').toUpperCase();
  const src = document.getElementById('po-src')?.value||'all';
  let data = src==='all'?[...OKUL.current,...OKUL.arsiv]:src==='current'?[...OKUL.current]:[...OKUL.arsiv];
  data = data.filter(m=>{const me=getMyName();return me&&((m.h1||'').toUpperCase().includes(me)||(m.h2||'').toUpperCase().includes(me));});
  if (search) data = data.filter(m=>(m.salon+m.org).toUpperCase().includes(search));

  document.getElementById('po-count').textContent = data.length+' maÃ§';
  const tb = document.getElementById('okul-body');
  if (!data.length) { tb.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="empty-ic">ğŸ«</div><div class="empty-tx">MaÃ§ bulunamadÄ±</div></div></td></tr>`; return; }
  window._okul = data;
  tb.innerHTML = data.map((m,i)=>{
    const rol = myRole(m.h1,m.h2);
    const dateStr = parseTarih(m.tarih);
    const isFuture = new Date(dateStr+'T'+(m.saat||'23:59')) >= new Date();
    const btnColor = isFuture ? 'background:rgba(96,165,250,.15);color:#60a5fa;border:1px solid rgba(96,165,250,.3)' : 'background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.25)';
    const btnIcon = isFuture ? 'ğŸ“… Gelecek' : 'âœ… GeÃ§miÅŸ';
    return `<tr style="background:rgba(34,197,94,.04)">
      <td style="font-size:11px;white-space:nowrap">${m.tarih}</td>
      <td><strong>${m.saat}</strong></td>
      <td style="font-size:11px">${m.salon}</td>
      <td style="font-size:12px">${m.org}</td>
      <td><span class="badge b-yellow" style="font-size:10px">${m.grup}</span></td>
      <td style="font-size:11px;color:var(--muted2)">${m.h1||'â€”'}</td>
      <td style="font-size:11px;color:var(--muted2)">${m.h2||'â€”'}</td>
      <td><span class="badge b-green" style="font-size:10px">${rol}</span></td>
      <td><button class="btn btn-sm" style="${btnColor};font-size:11px;padding:4px 10px" onclick="okulEkle(${i})">${btnIcon}</button></td>
    </tr>`;
  }).join('');
};

window.renderOzel = function() {
  const search = (document.getElementById('pz-search')?.value||'').toUpperCase();
  let data = OZEL.filter(m=>{const me=getMyName();return me&&((m.h1||'').toUpperCase().includes(me)||(m.h2||'').toUpperCase().includes(me));});
  if (search) data = data.filter(m=>(m.salon+m.org).toUpperCase().includes(search));
  document.getElementById('pz-count').textContent = data.length+' maÃ§';
  const tb = document.getElementById('ozel-body');
  if (!data.length) { tb.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-ic">ğŸ†</div><div class="empty-tx">MaÃ§ bulunamadÄ±</div></div></td></tr>`; return; }
  window._ozel = data;
  tb.innerHTML = data.map((m,i)=>{
    const rol = myRole(m.h1,m.h2);
    const dateStr = parseTarih(m.tarih);
    const isFuture = new Date(dateStr+'T'+(m.saat||'23:59')) >= new Date();
    const btnColor = isFuture ? 'background:rgba(96,165,250,.15);color:#60a5fa;border:1px solid rgba(96,165,250,.3)' : 'background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.25)';
    const btnIcon = isFuture ? 'ğŸ“… Gelecek' : 'âœ… GeÃ§miÅŸ';
    return `<tr style="background:rgba(96,165,250,.04)">
      <td style="font-size:11px;white-space:nowrap">${m.tarih}</td>
      <td style="font-size:11px">${m.salon}</td>
      <td><strong>${m.saat}</strong></td>
      <td style="font-size:12px">${m.a||'â€”'}</td>
      <td style="font-size:12px">${m.b||'â€”'}</td>
      <td><span class="badge b-blue" style="font-size:10px">${m.org}</span></td>
      <td style="font-size:11px;color:var(--muted2)">${m.h1||'â€”'}</td>
      <td style="font-size:11px;color:var(--muted2)">${m.h2||'â€”'}</td>
      <td><span class="badge b-blue" style="font-size:10px">${rol}</span></td>
      <td><button class="btn btn-sm" style="${btnColor};font-size:11px;padding:4px 10px" onclick="ozelEkle(${i})">${btnIcon}</button></td>
    </tr>`;
  }).join('');
};

// â”€â”€â”€ HAFTA EKLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.haftaEkle = async function(i) {
  const m = window._hafta[i]; if(!m) return;
  const dateStr = parseTarih(m.tarih);
  const rol = myRole(m.h1,m.h2);
  const isFuture = new Date(dateStr+'T'+(m.saat||'23:59')) >= new Date();
  const autoFee = FEES.bolge;

  setSync('syncing');
  try {
    await addDoc(col,{home:m.ev||'â€”',away:m.dep||'â€”',date:dateStr,time:m.saat,league:m.kat||'',location:m.salon,role:rol==='BaÅŸhakem'?'BaÅŸhakem':'2. Hakem',fee:autoFee,payment:'Bekleniyor',notes:m.grup||'',createdAt:new Date().toISOString(),autoAdded:true});
    if (isFuture) {
      toast(`ğŸ“… Gelecek maÃ§lara eklendi! (â‚º${autoFee.toLocaleString('tr-TR')})`, 'ok');
      go('upcoming'); setTimeout(()=>upcomingTab('bolge'),80);
    } else {
      toast(`âœ… GeÃ§miÅŸ maÃ§lara eklendi! (â‚º${autoFee.toLocaleString('tr-TR')})`, 'ok');
      go('past'); setTimeout(()=>pastTab('bolge'),80);
    }
  } catch(e) { setSync('error'); toast('Hata: '+e.message,'err'); }
};


// â”€â”€â”€ OKUL EKLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.okulEkle = async function(i) {
  const m = window._okul[i]; if(!m) return;
  const dateStr = parseTarih(m.tarih);
  const rol = myRole(m.h1,m.h2);
  const isFuture = new Date(dateStr+'T'+(m.saat||'23:59')) >= new Date();
  const autoFee = FEES.okul;
  setSync('syncing');
  try {
    await addDoc(col,{home:m.org,away:m.grup,date:dateStr,time:m.saat,league:m.org+' â€” Okul Ä°l/Ä°lÃ§e',location:m.salon,role:rol==='BaÅŸhakem'?'BaÅŸhakem':'2. Hakem',fee:autoFee,payment:'Bekleniyor',notes:'Okul Ä°l ve Ä°lÃ§e',category:'okul',createdAt:new Date().toISOString(),autoAdded:true});
    if (isFuture) { toast(`ğŸ“… Gelecek maÃ§lara eklendi! (â‚º${autoFee.toLocaleString('tr-TR')})`,'ok'); go('upcoming'); setTimeout(()=>upcomingTab('okul'),80); }
    else { toast(`âœ… GeÃ§miÅŸ maÃ§lara eklendi! (â‚º${autoFee.toLocaleString('tr-TR')})`,'ok'); go('past'); setTimeout(()=>pastTab('okul'),80); }
  } catch(e) { setSync('error'); toast('Hata: '+e.message,'err'); }
};

// â”€â”€â”€ Ã–ZEL EKLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.ozelEkle = async function(i) {
  const m = window._ozel[i]; if(!m) return;
  const dateStr = parseTarih(m.tarih);
  const rol = myRole(m.h1,m.h2);
  const isFuture = new Date(dateStr+'T'+(m.saat||'23:59')) >= new Date();
  const isGelisim = m.org.toUpperCase().includes('GELÄ°ÅÄ°M') || m.org.toUpperCase().includes('GELISIM');
  const autoFee = isGelisim ? FEES.gelisim : 0;
  const feeLabel = isGelisim ? `â‚º${autoFee.toLocaleString('tr-TR')}` : 'Manuel (â‚º0)';
  setSync('syncing');
  try {
    await addDoc(col,{home:m.a||m.org,away:m.b||'â€”',date:dateStr,time:m.saat,league:m.org,location:m.salon,role:rol==='BaÅŸhakem'?'BaÅŸhakem':'2. Hakem',fee:autoFee,payment:'Bekleniyor',notes:'Ã–zel Lig & Ãœniversite',category:'ozel',createdAt:new Date().toISOString(),autoAdded:true});
    if (isFuture) { toast(`ğŸ“… Gelecek maÃ§lara eklendi! (${feeLabel})`,'ok'); go('upcoming'); setTimeout(()=>upcomingTab('ozel'),80); }
    else { toast(`âœ… GeÃ§miÅŸ maÃ§lara eklendi! (${feeLabel})`,'ok'); go('past'); setTimeout(()=>pastTab('ozel'),80); }
  } catch(e) { setSync('error'); toast('Hata: '+e.message,'err'); }
};

// â”€â”€â”€ AUTO SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function autoSync() {
  const now = new Date();
  const all = [];

  const _isMyMatch = (m) => { const me=getMyName(); return me&&((m.h1||'').toUpperCase().includes(me)||(m.h2||'').toUpperCase().includes(me)); };

  for (const [wk,arr] of Object.entries(HAFTA)) {
    for (const m of arr) {
      if (!_isMyMatch(m)) continue;
      const date = parseTarih(m.tarih);
      const rol = myRole(m.h1,m.h2);
      all.push({home:m.ev||'â€”',away:m.dep||'â€”',date,time:m.saat,league:m.kat+' â€” '+wk+'. Hafta',location:m.salon,role:rol,fee:FEES.bolge,payment:'Bekleniyor',notes:m.grup||'',_k:date+'|'+(m.ev||'')+'|'+(m.dep||'')});
    }
  }
  for (const src of ['current','arsiv']) {
    for (const m of OKUL[src]) {
      if (!_isMyMatch(m)) continue;
      const date = parseTarih(m.tarih);
      const rol = myRole(m.h1,m.h2);
      all.push({home:m.org,away:m.grup,date,time:m.saat,league:m.org,location:m.salon,role:rol,fee:FEES.okul,payment:'Bekleniyor',notes:'Okul Ä°l ve Ä°lÃ§e',category:'okul',_k:date+'|'+m.saat+'|'+m.salon});
    }
  }
  for (const m of OZEL) {
    if (!_isMyMatch(m)) continue;
    const date = parseTarih(m.tarih);
    const rol = myRole(m.h1,m.h2);
    const ozelFee = m.org.toUpperCase().includes('GELÄ°ÅÄ°M') ? FEES.gelisim : 0;
    all.push({home:m.a||m.org,away:m.b||'â€”',date,time:m.saat,league:m.org,location:m.salon,role:rol,fee:ozelFee,payment:'Bekleniyor',notes:'Ã–zel Lig & Ãœniversite',category:'ozel',_k:date+'|'+m.saat+'|'+m.salon});
  }

  // TÃ¼m maÃ§lar: geÃ§miÅŸ ve gelecek
  const existK  = new Set(matches.map(m=>m.date+'|'+(m.home||'')+'|'+(m.away||'')));
  const existLT = new Set(matches.map(m=>m.date+'|'+(m.time||'')+'|'+(m.location||'')));
  const toAdd = all.filter(m=>!existK.has(m._k)&&!existLT.has(m.date+'|'+m.time+'|'+m.location));

  if (!toAdd.length) return;
  setSync('syncing');
  let nPast=0, nFuture=0;
  for (const m of toAdd) {
    try {
      const isFuture = new Date(m.date+'T'+(m.time||'23:59')) >= now;
      const {_k,...d} = m;
      await addDoc(col,{...d,createdAt:new Date().toISOString(),autoAdded:true});
      if (isFuture) nFuture++; else nPast++;
    }
    catch(e) { console.error(e); }
  }
  const parts = [];
  if (nFuture>0) parts.push(`${nFuture} gelecek`);
  if (nPast>0)   parts.push(`${nPast} geÃ§miÅŸ`);
  if (parts.length) toast(`âœ“ ${parts.join(' + ')} maÃ§ otomatik eklendi!`,'ok');
}

window.manualSync = async function() {
  _firstLoad = true;
  toast('ğŸ”„ TaranÄ±yor...','');
  await autoSync();
};

// â”€â”€â”€ FIREBASE CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.saveMatch = async function() {
  if (!col) { toast('Ã–nce giriÅŸ yapÄ±n','err'); return; }
  const home=document.getElementById('f-home').value.trim();
  const away=document.getElementById('f-away').value.trim();
  const date=document.getElementById('f-date').value;
  const time=document.getElementById('f-time').value;
  const league=document.getElementById('f-league').value;
  const location=document.getElementById('f-loc').value.trim();
  const role=document.getElementById('f-role').value;
  const fee=parseFloat(document.getElementById('f-fee').value)||0;
  const payment=document.getElementById('f-payment').value;
  const notes=document.getElementById('f-notes').value.trim();
  if (!home||!away||!date) { toast('TakÄ±m adlarÄ± ve tarih zorunlu','err'); return; }
  setSync('syncing');
  try {
    await addDoc(col,{home,away,date,time,league,location,role,fee,payment,notes,createdAt:new Date().toISOString()});
    clearForm(); toast('âœ“ MaÃ§ kaydedildi!','ok'); go('dashboard');
  } catch(e) { setSync('error'); toast('Hata: '+e.message,'err'); }
};

window.markPaid = async function(id) {
  try { await updateDoc(doc(db,'matches',id),{payment:'Ã–dendi'}); toast('âœ“ Ã–dendi iÅŸaretlendi','ok'); }
  catch(e) { toast('Hata','err'); }
};

window.deleteMatch = async function(id) {
  if (!confirm('Bu maÃ§Ä± silmek istiyormusunuz?')) return;
  try { await deleteDoc(doc(db,'matches',id)); toast('MaÃ§ silindi',''); }
  catch(e) { toast('Silme hatasÄ±','err'); }
};

// â”€â”€â”€ EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openEdit = function(id) {
  const m=matches.find(x=>x.id===id); if(!m) return;
  _editId=id;
  document.getElementById('edit-sub').textContent = m.home+' â€” '+m.away+'  Â·  '+fmtDate(m.date)+(m.time?' '+m.time:'');

  // Ãœcret 0 veya girilmemiÅŸse kategoriyi tahmin edip otomatik doldur
  let fee = m.fee||0;
  if (!fee) {
    const suggestedFee = guessFee(m);
    fee = suggestedFee;
  }
  document.getElementById('e-fee').value = fee;

  document.getElementById('e-payment').value=m.payment||'Bekleniyor';
  document.getElementById('e-league').value=m.league||'';
  document.getElementById('e-role').value=m.role||'2. Hakem';
  document.getElementById('e-notes').value=m.notes||'';
  document.getElementById('edit-modal').classList.add('open');

  // GÃ¶rsel ipucu: hangi tarife uygulandÄ±
  const cat = guessCat(m);
  const lig = (m.league||'').toUpperCase();
  const label = cat==='okul' ? 'ğŸ« Okul Ä°l/Ä°lÃ§e â†’ â‚º320'
               : cat==='bolge' ? 'ğŸ“‹ BÃ¶lge MaÃ§Ä± â†’ â‚º748'
               : lig.includes('GELÄ°ÅÄ°M') ? 'ğŸ† GeliÅŸim Ligi â†’ â‚º1.200'
               : 'ğŸ† Ã–zel Lig â†’ manuel';
  let hint = document.getElementById('fee-hint');
  if (!hint) {
    hint = document.createElement('div');
    hint.id = 'fee-hint';
    hint.style.cssText = 'font-size:11px;color:var(--acc);margin-top:4px;';
    document.getElementById('e-fee').parentNode.appendChild(hint);
  }
  hint.textContent = (m.fee||0) ? '' : 'â†‘ Otomatik: ' + label;
};
window.closeEdit = function() { document.getElementById('edit-modal').classList.remove('open'); _editId=null; };
document.getElementById('edit-modal').addEventListener('click',e=>{ if(e.target===document.getElementById('edit-modal')) closeEdit(); });

window.saveEdit = async function() {
  if (!_editId) return;
  setSync('syncing');
  try {
    await updateDoc(doc(db,'matches',_editId),{
      fee:parseFloat(document.getElementById('e-fee').value)||0,
      payment:document.getElementById('e-payment').value,
      league:document.getElementById('e-league').value.trim(),
      role:document.getElementById('e-role').value,
      notes:document.getElementById('e-notes').value.trim()
    });
    closeEdit(); toast('âœ“ GÃ¼ncellendi!','ok');
  } catch(e) { setSync('error'); toast('Hata: '+e.message,'err'); }
};
window.deleteFromEdit = async function() {
  if (!_editId) return;
  if (!confirm('Silmek istediÄŸinizden emin misiniz?')) return;
  try { await deleteDoc(doc(db,'matches',_editId)); closeEdit(); toast('Silindi',''); }
  catch(e) { toast('Hata','err'); }
};

// â”€â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.clearForm = function() {
  ['f-home','f-away','f-time','f-loc','f-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-fee').value='';
  document.getElementById('f-league').value='';
  document.getElementById('f-role').value='BaÅŸhakem';
  document.getElementById('f-payment').value='Bekleniyor';
};

window.onLeague = function() { document.getElementById('f-home').value=''; document.getElementById('f-away').value=''; };

// â”€â”€â”€ SUGGEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.suggest = function(inp,list) {
  const q=(document.getElementById(inp).value||'').trim().toUpperCase();
  const box=document.getElementById(list);
  if (!q) { box.classList.remove('open'); return; }
  const res=TEAMS.filter(t=>t.toUpperCase().includes(q)).slice(0,8);
  if (!res.length) { box.classList.remove('open'); return; }
  box.innerHTML=res.map(t=>{
    const hi=t.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'),x=>`<mark>${x}</mark>`);
    return `<div class="sug-item" onclick="pickTeam('${inp}','${list}','${t.replace(/'/g,"\\'")}')">ğŸ€ ${hi}</div>`;
  }).join('');
  box.classList.add('open');
};
window.pickTeam = function(inp,list,v) { document.getElementById(inp).value=v; document.getElementById(list).classList.remove('open'); };
document.addEventListener('click',e=>{ ['sl-home','sl-away'].forEach(id=>{ const el=document.getElementById(id); if(el&&!el.contains(e.target)&&e.target.id!=='f-home'&&e.target.id!=='f-away') el.classList.remove('open'); }); });

// â”€â”€â”€ PWA & PUSH BÄ°LDÄ°RÄ°MLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pwaInstallEvt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaInstallEvt = e;
  const btn = document.getElementById('btn-pwa-install');
  if (btn) btn.style.display = 'inline-flex';
});

window.pwaTriggerInstall = function() {
  if (_pwaInstallEvt) { _pwaInstallEvt.prompt(); }
};

function savePushSettings() {
  LS.setItem('rt_settings', JSON.stringify(settings));
}

window.togglePushPref = function(btn, key) {
  btn.classList.toggle('on');
  if (!settings.pushNotifs) settings.pushNotifs = {};
  settings.pushNotifs[key] = btn.classList.contains('on');
  savePushSettings();
};

function updatePermUI() {
  const perm = Notification.permission;
  const box  = document.getElementById('pwa-perm-box');
  const title = document.getElementById('perm-title');
  const sub   = document.getElementById('perm-sub');
  const btn   = document.getElementById('btn-req-perm');
  if (!box) return;
  if (perm === 'granted') {
    box.style.background = 'rgba(34,197,94,.08)';
    box.style.borderColor = 'rgba(34,197,94,.3)';
    title.innerHTML = 'âœ… Bildirimler Aktif';
    sub.textContent = 'Telefonuna bildirim gÃ¶nderebiliyoruz';
    if (btn) btn.style.display = 'none';
  } else if (perm === 'denied') {
    box.style.background = 'rgba(248,113,113,.08)';
    box.style.borderColor = 'rgba(248,113,113,.3)';
    title.innerHTML = 'âŒ Bildirim Ä°zni Reddedildi';
    sub.textContent = 'TarayÄ±cÄ± ayarlarÄ±ndan bu site iÃ§in izin ver';
    if (btn) btn.style.display = 'none';
  } else {
    box.style.background = 'rgba(249,115,22,.08)';
    box.style.borderColor = 'rgba(249,115,22,.3)';
    title.innerHTML = 'âš ï¸ Ä°zin Verilmedi';
    sub.textContent = 'Bildirim almak iÃ§in izin gerekiyor';
    if (btn) btn.style.display = 'inline-flex';
  }
}

window.requestPushPermission = async function() {
  const perm = await Notification.requestPermission();
  updatePermUI();
  if (perm === 'granted') toast('âœ… Bildirimler aktif!', 'ok');
  else toast('âš ï¸ Ä°zin verilmedi', 'err');
};

function sendPush(title, body, tag) {
  if (Notification.permission !== 'granted') return;
  const n = new Notification(title, {
    body,
    tag: tag || 'reftrack-notif',
    icon: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/72x72/1f3c0.png',
    badge: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/72x72/1f3c0.png',
    requireInteraction: true
  });
  n.onclick = () => { window.focus(); n.close(); };
}

window.sendTestPush = function() {
  if (Notification.permission !== 'granted') {
    requestPushPermission().then(() => {
      if (Notification.permission === 'granted')
        sendPush('ğŸ€ RefTrack Test', 'Bildirimler Ã§alÄ±ÅŸÄ±yor! MaÃ§ Ã¶ncesi burada gÃ¶receksin.', 'test');
    });
    return;
  }
  sendPush('ğŸ€ RefTrack Test', 'Bildirimler Ã§alÄ±ÅŸÄ±yor! MaÃ§ Ã¶ncesi burada gÃ¶receksin.', 'test');
  toast('âœ… Test bildirimi gÃ¶nderildi', 'ok');
};

window.sendMatchPush = function() {
  const sel = document.getElementById('notif-match-sel');
  if (!sel || !sel.value) { toast('âš ï¸ MaÃ§ seÃ§', 'err'); return; }
  const m = getUpcoming()[parseInt(sel.value)];
  if (!m) return;
  const d = fmtDate(m.date);
  sendPush(
    `ğŸ€ ${m.home} â€” ${m.away}`,
    `ğŸ“… ${d} ${m.time||''}
ğŸ“ ${m.location||'â€”'}
ğŸ‘¤ ${m.role}`,
    'match-' + m.id
  );
  toast('ğŸ”” Bildirim gÃ¶nderildi', 'ok');
};

// Otomatik bildirim kontrolÃ¼ â€” uygulama aÃ§Ä±kken her dakika Ã§alÄ±ÅŸÄ±r
function checkAutoNotifs() {
  if (Notification.permission !== 'granted') return;
  const now = new Date();
  const upcoming = getUpcoming();
  if (!settings.notifSent) settings.notifSent = {};
  let changed = false;

  upcoming.forEach(m => {
    const matchDt = new Date(m.date + 'T' + (m.time || '09:00'));
    const diffMs = matchDt - now;
    const diffH  = diffMs / 3600000;
    const diffD  = diffMs / 86400000;
    const label  = `${m.home} â€” ${m.away}`;

    // 2 saat Ã¶ncesi
    if (settings.pushNotifs?.['2h'] && diffH > 0 && diffH <= 2) {
      const key = '2h_' + m.id;
      if (!settings.notifSent[key]) {
        sendPush(`â° 2 Saat KaldÄ±!`, `ğŸ€ ${label}
ğŸ“ ${m.location||'â€”'} Â· ${m.time}`, key);
        settings.notifSent[key] = true; changed = true;
      }
    }
    // MaÃ§ gÃ¼nÃ¼ sabahÄ± 08:00
    if (settings.pushNotifs?.morning) {
      const matchDay = m.date;
      const todayStr = now.toISOString().split('T')[0];
      const hour = now.getHours();
      if (matchDay === todayStr && hour >= 8) {
        const key = 'morning_' + m.id;
        if (!settings.notifSent[key]) {
          sendPush(`ğŸ€ BugÃ¼n MaÃ§Ä±n Var!`, `${label}
â° ${m.time||'â€”'} Â· ğŸ“ ${m.location||'â€”'}`, key);
          settings.notifSent[key] = true; changed = true;
        }
      }
    }
    // 1 gÃ¼n Ã¶ncesi akÅŸam 20:00
    if (settings.pushNotifs?.day && diffD > 0 && diffD <= 1.2) {
      const hour = now.getHours();
      if (hour >= 20) {
        const key = 'day_' + m.id;
        if (!settings.notifSent[key]) {
          sendPush(`ğŸ“… YarÄ±n MaÃ§Ä±n Var!`, `ğŸ€ ${label}
â° ${m.time||'â€”'} Â· ğŸ“ ${m.location||'â€”'}`, key);
          settings.notifSent[key] = true; changed = true;
        }
      }
    }
  });

  if (changed) savePushSettings();
}

// Her 60 saniyede bir kontrol
setInterval(checkAutoNotifs, 60000);

// Eski saveEmail uyumluluk
window.saveEmail = function() { savePushSettings(); };

// â”€â”€â”€ RENDER ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  window._renderAll = renderAll;
  renderStats(); renderDash(); renderUpcomingList(); renderPastList(); renderFinance(); renderNotif(); renderProfile();
  checkAutoNotifs();

  // Update dashboard hero name dynamically
  const nameEl=document.getElementById('dash-name-span');
  if(nameEl && currentUser) {
    const parts=(currentUser.refName||currentUser.displayName||'Hakem').split(' ');
    const last=parts.pop()||'';
    nameEl.innerHTML=parts.join(' ')+' <span>'+last+'</span>';
  }
}

function renderStats() {
  const now=new Date();
  const past=getPast(); const upcoming=getUpcoming();
  const thisMonth=past.filter(m=>{ const d=new Date(m.date); return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear(); });
  const earn=thisMonth.reduce((s,m)=>s+m.fee,0);
  const unpaid=matches.filter(m=>m.payment==='Bekleniyor').reduce((s,m)=>s+m.fee,0);
  document.getElementById('s-month').textContent=thisMonth.length;
  document.getElementById('s-upcoming').textContent=upcoming.length;
  document.getElementById('s-earn').textContent='â‚º'+earn.toLocaleString('tr-TR');
  document.getElementById('s-unpaid').textContent='â‚º'+unpaid.toLocaleString('tr-TR');

  // kategori kartlarÄ± â€” sadece ÅEMSETTÄ°N KEMAL ATAK'Ä±n maÃ§larÄ±
  const isMine = (h) => { const me=getMyName(); return me&&((h.h1||'').toUpperCase().includes(me)||(h.h2||'').toUpperCase().includes(me)); };
  const bolgeMine = Object.values(HAFTA).flat().filter(isMine);
  document.getElementById('cc-bolge').textContent = bolgeMine.length;
  document.getElementById('cc-bolge-d').innerHTML = Object.entries(HAFTA).map(([wk,arr])=>{
    const n=arr.filter(isMine).length; return n>0?`<span class="cc-chip" style="color:var(--acc)">${wk}. Hafta: ${n}</span>`:'';
  }).join('');

  const okulMine = [...OKUL.current,...OKUL.arsiv].filter(isMine);
  const okulOrgs = {};
  okulMine.forEach(h=>okulOrgs[h.org]=(okulOrgs[h.org]||0)+1);
  document.getElementById('cc-okul').textContent = okulMine.length;
  document.getElementById('cc-okul-d').innerHTML = Object.entries(okulOrgs).map(([o,n])=>`<span class="cc-chip" style="color:var(--green)">${o}: ${n}</span>`).join('');

  const ozelMine = OZEL.filter(isMine);
  document.getElementById('cc-ozel').textContent = ozelMine.length;
  document.getElementById('cc-ozel-d').innerHTML = ozelMine.map(h=>`<span class="cc-chip" style="color:var(--blue)">${h.tarih.split(' ').slice(0,3).join(' ')} Â· ${h.org}</span>`).join('');
}

function renderDash() {
  // upcoming alerts
  const up=getUpcoming().slice(0,3);
  const du=document.getElementById('d-upcoming');
  if (!up.length) { du.innerHTML='<div class="empty"><div class="empty-ic">ğŸ“­</div><div class="empty-tx">YaklaÅŸan maÃ§ yok</div></div>'; }
  else du.innerHTML=up.map(m=>`<div class="ua">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="ua-dot"></div>
      <div>
        <div class="ua-title">${m.home} â€” ${m.away}</div>
        <div class="ua-sub">ğŸ“… ${fmtDate(m.date)} ${m.time||''} Â· ğŸ“ ${m.location||'â€”'} Â· <span class="role-badge">${m.role}</span></div>
      </div>
    </div>
    <div style="text-align:right"><div class="countdown">${timeLeft(m)}</div><div style="font-size:10px;color:var(--muted);margin-top:2px">${m.league||''}</div></div>
  </div>`).join('');

  // recent past
  const past=getPast().slice(0,5);
  const dp=document.getElementById('d-past');
  if (!past.length) { dp.innerHTML='<tr><td colspan="6"><div class="empty" style="padding:24px"><div class="empty-ic">ğŸ€</div><div class="empty-tx">HenÃ¼z maÃ§ eklenmedi</div></div></td></tr>'; return; }
  dp.innerHTML=past.map(m=>{
    const lig=guessLig(m);
    return `<tr>
      <td>${fmtDate(m.date)}</td>
      <td><strong>${m.home}</strong> â€” ${m.away}</td>
      <td style="font-size:11px;max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${lig}</td>
      <td><span class="role-badge">${m.role}</span></td>
      <td><strong>â‚º${(m.fee||0).toLocaleString('tr-TR')}</strong></td>
      <td>${m.payment==='Ã–dendi'?'<span class="badge b-green">âœ“ Ã–dendi</span>':'<span class="badge b-yellow">â³ Bekliyor</span>'}</td>
    </tr>`;
  }).join('');
}

// Aktif gelecek sekme state'i
let _upcomingTab = 'bolge';

window.upcomingTab = function(tab) {
  _upcomingTab = tab;
  ['bolge','okul','ozel'].forEach(t => {
    document.getElementById('uptab-btn-'+t)?.classList.toggle('active', t===tab);
  });
  renderUpcomingList();
};

function renderUpcomingList() {
  const all = getUpcoming();
  const filtered = _upcomingTab === 'all' ? all : all.filter(m => guessCat(m) === _upcomingTab);
  const c = document.getElementById('upcoming-list');

  // Sekme sayÄ±larÄ±nÄ± gÃ¼ncelle
  const counts = {bolge:0, okul:0, ozel:0};
  all.forEach(m => counts[guessCat(m)]++);
  ['bolge','okul','ozel'].forEach(t => {
    const btn = document.getElementById('uptab-btn-'+t);
    if (!btn) return;
    const ico = t==='bolge'?'ğŸ“‹':t==='okul'?'ğŸ«':'ğŸ†';
    const lbl = t==='bolge'?'BÃ¶lge MaÃ§larÄ±':t==='okul'?'Okul Ä°l ve Ä°lÃ§e':'Ã–zel Lig & Ãœniversite';
    btn.textContent = `${ico} ${lbl} (${counts[t]})`;
  });

  if (!filtered.length) {
    const icons = {bolge:'ğŸ“‹', okul:'ğŸ«', ozel:'ğŸ†'};
    const labels = {bolge:'BÃ¶lge maÃ§Ä± planlanmamÄ±ÅŸ', okul:'Okul maÃ§Ä± planlanmamÄ±ÅŸ', ozel:'Ã–zel lig maÃ§Ä± planlanmamÄ±ÅŸ'};
    c.innerHTML=`<div class="card"><div class="empty"><div class="empty-ic">${icons[_upcomingTab]||'ğŸ“…'}</div><div class="empty-tx">${labels[_upcomingTab]||'PlanlanmÄ±ÅŸ maÃ§ yok'}</div></div></div>`;
    return;
  }
  c.innerHTML=filtered.map(m=>`<div class="ua">
    <div style="display:flex;align-items:center;gap:12px;flex:1">
      <div class="ua-dot"></div>
      <div>
        <div class="ua-title">${m.home} â€” ${m.away}</div>
        <div class="ua-sub">ğŸ“… ${fmtDate(m.date)} ${m.time||''} &nbsp;|&nbsp; ğŸ“ ${m.location||'â€”'} &nbsp;|&nbsp; ğŸ† ${m.league||'â€”'}</div>
        <div style="margin-top:5px"><span class="role-badge">${m.role}</span> &nbsp;<span class="badge b-orange">â‚º${(m.fee||0).toLocaleString('tr-TR')}</span></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:7px">
      <div class="countdown">${timeLeft(m)}</div>
      <button class="btn btn-ghost btn-sm" onclick="openEdit('${m.id}')">âœï¸ DÃ¼zenle</button>
      <button class="btn btn-danger btn-sm" onclick="deleteMatch('${m.id}')">ğŸ—‘ Sil</button>
    </div>
  </div>`).join('');
}

// Aktif geÃ§miÅŸ sekme state'i
let _pastTab = 'bolge';

window.pastMode = function(mode) {
  pastTab(mode);
};

window.pastTab = function(tab) {
  _pastTab = tab;
  ['month','bolge','okul','ozel'].forEach(t => {
    document.getElementById('pasttab-btn-'+t)?.classList.toggle('active', t===tab);
  });
  renderPastList();
};

function renderPastList() {
  const all = getPast();
  const now = new Date();
  let filtered;
  if (_pastTab === 'month') {
    filtered = all.filter(m => {
      const d = new Date(m.date);
      return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
    });
  } else {
    filtered = all.filter(m => guessCat(m) === _pastTab);
  }
  const tb = document.getElementById('past-list');
  
  // Sekme sayÄ±larÄ±nÄ± gÃ¼ncelle
  const monthCount = all.filter(m => { const d=new Date(m.date); return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear(); }).length;
  const counts = {bolge:0, okul:0, ozel:0};
  all.forEach(m => counts[guessCat(m)]++);
  
  const monthBtn = document.getElementById('pasttab-btn-month');
  if (monthBtn) monthBtn.textContent = `ğŸ“… Bu Ay (${monthCount})`;
  
  ['bolge','okul','ozel'].forEach(t => {
    const btn = document.getElementById('pasttab-btn-'+t);
    if (!btn) return;
    const ico = t==='bolge'?'ğŸ“‹':t==='okul'?'ğŸ«':'ğŸ†';
    const lbl = t==='bolge'?'BÃ¶lge MaÃ§larÄ±':t==='okul'?'Okul Ä°l ve Ä°lÃ§e':'Ã–zel Lig & Ãœniversite';
    btn.textContent = `${ico} ${lbl} (${counts[t]})`;
  });

  if (!filtered.length) {
    const emptyIco = _pastTab==='month'?'ğŸ“…':_pastTab==='bolge'?'ğŸ“‹':_pastTab==='okul'?'ğŸ«':'ğŸ†';
    const emptyMsg = _pastTab==='month'?'Bu ay tamamlanan maÃ§ yok':_pastTab==='bolge'?'BÃ¶lge maÃ§Ä± bulunamadÄ±':_pastTab==='okul'?'Okul maÃ§Ä± bulunamadÄ±':'Ã–zel lig maÃ§Ä± bulunamadÄ±';
    tb.innerHTML=`<tr><td colspan="8"><div class="empty" style="padding:32px"><div class="empty-ic">${emptyIco}</div><div class="empty-tx">${emptyMsg}</div></div></td></tr>`;
    return;
  }
  tb.innerHTML=filtered.map(m=>{
    const lig=guessLig(m);
    const cat=guessCat(m);
    const catIco=cat==='bolge'?'ğŸ“‹':cat==='okul'?'ğŸ«':'ğŸ†';
    const paid=m.payment==='Ã–dendi';
    return `<tr>
      <td style="white-space:nowrap">${fmtDate(m.date)}${m.time?`<br><span style="color:var(--muted);font-size:11px">${m.time}</span>`:''}</td>
      <td><strong>${m.home}</strong><br><span style="color:var(--muted);font-size:11px">${m.away}</span></td>
      <td style="font-size:11px">${catIco} ${lig}</td>
      <td style="font-size:12px;color:var(--muted2)">${m.location||'â€”'}</td>
      <td><span class="role-badge">${m.role}</span></td>
      <td><strong>â‚º${(m.fee||0).toLocaleString('tr-TR')}</strong></td>
      <td>${paid?'<span class="badge b-green">âœ“ Ã–dendi</span>':`<span class="badge b-yellow">â³ Bekliyor</span><br><button class="btn btn-green btn-sm" style="margin-top:4px;font-size:10px" onclick="markPaid('${m.id}')">Ã–dendi Ä°ÅŸaretle</button>`}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-ghost btn-sm" style="margin-right:4px" onclick="openEdit('${m.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deleteMatch('${m.id}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');
}

function renderFinance() {
  const total=matches.reduce((s,m)=>s+(m.fee||0),0);
  const paid=matches.filter(m=>m.payment==='Ã–dendi').reduce((s,m)=>s+(m.fee||0),0);
  const pend=matches.filter(m=>m.payment==='Bekleniyor').reduce((s,m)=>s+(m.fee||0),0);
  const now=new Date();
  const month=matches.filter(m=>{ const d=new Date(m.date); return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear(); }).reduce((s,m)=>s+(m.fee||0),0);
  document.getElementById('f-total').textContent='â‚º'+total.toLocaleString('tr-TR');
  document.getElementById('f-paid').textContent='â‚º'+paid.toLocaleString('tr-TR');
  document.getElementById('f-pend').textContent='â‚º'+pend.toLocaleString('tr-TR');
  document.getElementById('f-month').textContent='â‚º'+month.toLocaleString('tr-TR');

  const byMonth={};
  matches.forEach(m=>{ const d=new Date(m.date); const k=d.toLocaleDateString('tr-TR',{month:'short',year:'2-digit'}); byMonth[k]=(byMonth[k]||0)+(m.fee||0); });
  const entries=Object.entries(byMonth).slice(-6);
  const mx=Math.max(...entries.map(e=>e[1]),1);
  document.getElementById('monthly-chart').innerHTML=entries.length?entries.map(([mo,v])=>`<div class="bar-row"><div class="bar-label">${mo}</div><div class="bar-track"><div class="bar-fill" style="width:${(v/mx)*100}%"></div></div><div class="bar-val">â‚º${v.toLocaleString('tr-TR')}</div></div>`).join(''):'<div class="empty"><div class="empty-ic">ğŸ“Š</div><div class="empty-tx">Veri yok</div></div>';

  const pendM=matches.filter(m=>m.payment==='Bekleniyor');
  document.getElementById('pend-count').textContent=pendM.length;
  document.getElementById('pend-list').innerHTML=pendM.length?pendM.map(m=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surf2);border-radius:8px;margin-bottom:7px;border:1px solid var(--border)">
    <div><div style="font-size:12px;font-weight:500">${m.home} â€” ${m.away}</div><div style="font-size:10px;color:var(--muted)">${fmtDate(m.date)}</div></div>
    <div style="display:flex;align-items:center;gap:9px"><strong style="color:var(--acc)">â‚º${(m.fee||0).toLocaleString('tr-TR')}</strong><button class="btn btn-green btn-sm" style="font-size:10px" onclick="markPaid('${m.id}')">Ã–dendi</button></div>
  </div>`).join(''):'<div class="empty" style="padding:24px"><div class="empty-ic">âœ…</div><div class="empty-tx">Bekleyen Ã¶deme yok</div></div>';

  // Kategori bazlÄ± Ã¶zet
  const catStats = {bolge:{label:'ğŸ“‹ BÃ¶lge MaÃ§Ä±',tarife:FEES.bolge,count:0,earn:0},okul:{label:'ğŸ« Okul Ä°l/Ä°lÃ§e',tarife:FEES.okul,count:0,earn:0},gelisim:{label:'ğŸ† GeliÅŸim Ligi',tarife:FEES.gelisim,count:0,earn:0},ozel:{label:'ğŸ† Ã–zel Lig',tarife:0,count:0,earn:0}};
  matches.forEach(m=>{
    const cat=guessCat(m);
    const lig=(m.league||'').toUpperCase();
    const key = cat==='okul'?'okul': cat==='bolge'?'bolge': lig.includes('GELÄ°ÅÄ°M')?'gelisim':'ozel';
    catStats[key].count++;
    catStats[key].earn+=(m.fee||0);
  });
  const catEl=document.getElementById('cat-breakdown');
  if(catEl) catEl.innerHTML=Object.entries(catStats).filter(([,v])=>v.count>0).map(([,v])=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--surf2);border-radius:10px;border:1px solid var(--border)">
      <div>
        <div style="font-size:13px;font-weight:600">${v.label}</div>
        <div style="font-size:11px;color:var(--muted)">${v.count} maÃ§${v.tarife?` Â· Tarife: â‚º${v.tarife.toLocaleString('tr-TR')}/maÃ§`:' Â· Manuel tarife'}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:15px;font-weight:700;color:var(--acc)">â‚º${v.earn.toLocaleString('tr-TR')}</div>
        ${v.tarife&&v.count?`<div style="font-size:10px;color:var(--muted)">Beklenen: â‚º${(v.tarife*v.count).toLocaleString('tr-TR')}</div>`:''}
      </div>
    </div>`).join('');
}

function renderNotif() {
  // Ä°zin durumu gÃ¼ncelle
  if (typeof Notification !== 'undefined') updatePermUI();

  // Toggle'larÄ± ayarlardan yÃ¼kle
  ['morning','day','2h'].forEach(k => {
    const btn = document.getElementById('tog-'+k);
    if (!btn) return;
    const on = settings.pushNotifs?.[k] !== false;
    btn.classList.toggle('on', on);
  });

  // YaklaÅŸan maÃ§lar listesi
  const up = getUpcoming().slice(0,5);
  const c = document.getElementById('notif-q');
  c.innerHTML = up.length ? up.map((m,i) => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <div>
        <div style="font-size:12px;font-weight:500">${m.home} â€” ${m.away}</div>
        <div style="font-size:10px;color:var(--muted)">${fmtDate(m.date)} ${m.time||''} Â· ${m.location||'â€”'}</div>
      </div>
      <button onclick="(()=>{sendPush('ğŸ€ ${m.home.replace(/'/g,'')} â€” ${m.away.replace(/'/g,'')}','ğŸ“… ${fmtDate(m.date)} ${m.time||''} Â· ${m.location||'â€”'}','q${i}');toast('ğŸ”” GÃ¶nderildi','ok');})()" 
        style="background:transparent;border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--muted);font-size:10px;cursor:pointer">ğŸ””</button>
    </div>`).join('') : '<div style="color:var(--muted);padding:8px 0">YaklaÅŸan maÃ§ yok</div>';

  // Manuel gÃ¶nder select
  const sel = document.getElementById('notif-match-sel');
  if (sel) {
    sel.innerHTML = '<option value="">â€” MaÃ§ seÃ§ â€”</option>' +
      up.map((m,i) => `<option value="${i}">${fmtDate(m.date)} Â· ${m.home} â€” ${m.away}</option>`).join('');
  }
}





// â”€â”€â”€ CSV IMPORT (3 KATEGORÄ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _csvData = {bolge:[], okul:[], ozel:[]};
let _csvCat = 'bolge';

window.csvCatTab = function(cat) {
  _csvCat = cat;
  ['bolge','okul','ozel'].forEach(t => {
    document.getElementById('csvcat-'+t).style.display = t===cat ? '' : 'none';
    document.getElementById('csvcat-btn-'+t).classList.toggle('active', t===cat);
  });
  renderCsvHistory(cat);
};

// TÃ¼rkÃ§e tarih â†’ YYYY-MM-DD
function csvDate(t) {
  if (!t) return '';
  const mo = {'ocak':'01','ÅŸubat':'02','mart':'03','nisan':'04','mayÄ±s':'05','haziran':'06',
               'temmuz':'07','aÄŸustos':'08','eylÃ¼l':'09','ekim':'10','kasÄ±m':'11','aralÄ±k':'12',
               'subat':'02','mayis':'05','agustos':'08','eylul':'09','kasim':'11','aralik':'12'};
  const s = t.toLowerCase().trim();
  // "25 ÅŸubat 2026 Ã§arÅŸamba" veya "25 ÅŸubat 2026"
  const m1 = s.match(/(\d{1,2})\s+([a-zÅŸÄŸÃ¼Ã¶Ã§Ä±]+)\s+(\d{4})/);
  if (m1) return m1[3]+'-'+(mo[m1[2]]||'01')+'-'+m1[1].padStart(2,'0');
  // "25.02.2026" veya "25/02/2026"
  const m2 = t.match(/(\d{1,2})[./](\d{1,2})[./](\d{4})/);
  if (m2) return m2[3]+'-'+m2[2].padStart(2,'0')+'-'+m2[1].padStart(2,'0');
  if (/^\d{4}-\d{2}-\d{2}/.test(t)) return t.substring(0,10);
  return t;
}

// BaÅŸlÄ±k normalize
function normH(h) {
  return h.trim().toUpperCase()
    .replace(/\s+/g,'').replace(/\./g,'')
    .replace(/Ä°/g,'I').replace(/Å/g,'S').replace(/Ä/g,'G')
    .replace(/Ãœ/g,'U').replace(/Ã–/g,'O').replace(/Ã‡/g,'C');
}

// Benim rolÃ¼m
function myRole2(h1,h2) {
  const me = getMyName(); if(!me) return 'â€”';
  if ((h1||'').toUpperCase().includes(me)) return 'BaÅŸhakem';
  if ((h2||'').toUpperCase().includes(me)) return '2. Hakem';
  return 'â€”';
}

// CSV text â†’ satÄ±rlar
function splitCsv(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (!lines.length) return null;
  const first = lines[0];
  const sep = first.includes('\t') ? '\t' : first.includes(';') ? ';' : ',';
  return { sep, lines };
}

// â”€â”€ BÃ–LGE parse â”€â”€
// TARÄ°H | SALON | SAAT | A TAKIMI | B TAKIMI | KATEGORÄ° | GRUP | 1.HAKEM | 2.HAKEM
function parseBolge(text) {
  const r = splitCsv(text); if (!r) return null;
  const { sep, lines } = r;
  const headers = lines[0].split(sep).map(normH);
  const fi = (...ns) => { for (const n of ns) { const i=headers.findIndex(h=>h.includes(n)); if(i>=0)return i; } return -1; };
  const cTarih=fi('TARIH'), cSalon=fi('SALON','YER'), cSaat=fi('SAAT');
  const cA=fi('ATAKIMI','ATAKM','EVSAHIBI'), cB=fi('BTAKIMI','BTAKM','DEPLASMAN','MISAFIR');
  const cKat=fi('KATEGORI','KAT'), cGrup=fi('GRUP');
  const cH1=fi('1HAKEM','H1','BIRINCI'), cH2=fi('2HAKEM','H2','IKINCI');
  if (cTarih<0||cA<0||cB<0) return {error:'Zorunlu sÃ¼tunlar bulunamadÄ±: TARÄ°H, A TAKIMI, B TAKIMI\nBaÅŸlÄ±k: '+lines[0].substring(0,100)};
  // Format doÄŸrulama: BÃ¶lge CSV'sinde 1.HAKEM/2.HAKEM (numaralÄ±) olmalÄ±, ORGANÄ°ZASYON olmamalÄ±
  const hasNumberedRef = fi('1HAKEM','BIRINCI') >= 0 || fi('2HAKEM','IKINCI') >= 0;
  const hasOrg = fi('ORGANIZASYON','ORG') >= 0;
  if (hasOrg && !hasNumberedRef) return {error:'âŒ Bu CSV BÃ¶lge MaÃ§Ä± formatÄ±nda deÄŸil!\n\nBÃ¶lge CSV formatÄ±: TARÄ°H Â· SALON Â· SAAT Â· A TAKIMI Â· B TAKIMI Â· KATEGORÄ° Â· GRUP Â· 1.HAKEM Â· 2.HAKEM\n\nYÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z dosya Ã–zel Lig formatÄ±nda gÃ¶rÃ¼nÃ¼yor.'};
  if (!hasNumberedRef && fi('SAAT')>=0 && fi('SALON')>=0 && fi('GRUP')>=0 && fi('ATAKIMI','ATAKM')<0) return {error:'âŒ Bu CSV BÃ¶lge MaÃ§Ä± formatÄ±nda deÄŸil!\n\nBÃ¶lge CSV formatÄ±: TARÄ°H Â· SALON Â· SAAT Â· A TAKIMI Â· B TAKIMI Â· KATEGORÄ° Â· GRUP Â· 1.HAKEM Â· 2.HAKEM\n\nYÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z dosya Okul Ä°l/Ä°lÃ§e formatÄ±nda gÃ¶rÃ¼nÃ¼yor.'};
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(sep).map(s=>s.trim().replace(/^["']|["']$/g,''));
    if(c.every(x=>!x)) continue;
    rows.push({tarih:c[cTarih]||'',salon:cSalon>=0?c[cSalon]||'':'',saat:cSaat>=0?c[cSaat]||'':'',
               ev:c[cA]||'',dep:c[cB]||'',kat:cKat>=0?c[cKat]||'':'',grup:cGrup>=0?c[cGrup]||'':'',
               h1:cH1>=0?c[cH1]||'':'',h2:cH2>=0?c[cH2]||'':''});
  }
  return rows;
}

// â”€â”€ OKUL parse â”€â”€
// TARÄ°H | SAAT | SALON | ORGANÄ°ZASYON | GRUP | HAKEM | HAKEM
function parseOkul(text) {
  const r = splitCsv(text); if (!r) return null;
  const { sep, lines } = r;
  const raw = lines[0].split(sep).map(h => h.trim());
  const headers = raw.map(normH);

  // GerÃ§ek CSV yapÄ±sÄ± (baÅŸlÄ±k boÅŸ olabilir):
  // col0=TARÄ°H(boÅŸ baÅŸlÄ±k) Â· col1=SAAT Â· col2=SALON Â· col3=boÅŸ Â· col4=ORGANÄ°ZASYON Â· col5=GRUP Â· col6=HAKEM Â· col7=boÅŸ Â· col8=HAKEM
  // Ã–nce isimle bul, bulamazsa sabit pozisyon kullan

  const fi = (...ns) => { for (const n of ns) { const i=headers.findIndex(h=>h&&h.includes(n)); if(i>=0)return i; } return -1; };

  // Tarih: baÅŸlÄ±ÄŸÄ± boÅŸ olduÄŸu iÃ§in her zaman index 0
  const cTarih = 0;

  // SAAT: baÅŸlÄ±ÄŸa gÃ¶re ya da index 1
  let cSaat = fi('SAAT'); if(cSaat<0) cSaat=1;

  // SALON: baÅŸlÄ±ÄŸa gÃ¶re ya da index 2
  let cSalon = fi('SALON','YER'); if(cSalon<0) cSalon=2;

  // ORGANÄ°ZASYON: baÅŸlÄ±ÄŸa gÃ¶re ya da index 4 (col3 boÅŸ olduÄŸu iÃ§in)
  let cOrg = fi('ORGANIZASYON','ORG'); if(cOrg<0) cOrg=4;

  // GRUP: baÅŸlÄ±ÄŸa gÃ¶re ya da index 5
  let cGrup = fi('GRUP'); if(cGrup<0) cGrup=5;

  // Format doÄŸrulama: Okul CSV'sinde A TAKIMI/B TAKIMI olmamalÄ±
  const fiOkul = (...ns) => { for (const n of ns) { const i=headers.findIndex(h=>h&&h.includes(n)); if(i>=0)return i; } return -1; };
  const hasATeam = fiOkul('ATAKIMI','ATAKM','EVSAHIBI') >= 0;
  const hasBTeam = fiOkul('BTAKIMI','BTAKM','DEPLASMAN') >= 0;
  const hasNumRef = fiOkul('1HAKEM','BIRINCI') >= 0 || fiOkul('2HAKEM','IKINCI') >= 0;
  if (hasATeam && hasBTeam && hasNumRef) return {error:'âŒ Bu CSV Okul Ä°l ve Ä°lÃ§e formatÄ±nda deÄŸil!\n\nOkul CSV formatÄ±: TARÄ°H Â· SAAT Â· SALON Â· ORGANÄ°ZASYON Â· GRUP Â· HAKEM Â· HAKEM\n\nYÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z dosya BÃ¶lge MaÃ§Ä± formatÄ±nda gÃ¶rÃ¼nÃ¼yor.'};
  if (hasATeam && hasBTeam && !hasNumRef) return {error:'âŒ Bu CSV Okul Ä°l ve Ä°lÃ§e formatÄ±nda deÄŸil!\n\nOkul CSV formatÄ±: TARÄ°H Â· SAAT Â· SALON Â· ORGANÄ°ZASYON Â· GRUP Â· HAKEM Â· HAKEM\n\nYÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z dosya Ã–zel Lig formatÄ±nda gÃ¶rÃ¼nÃ¼yor.'};

  // HAKEM sÃ¼tunlarÄ±: aynÄ± isimde 2 tane var, sÄ±rayla al
  // col6=HAKEM, col7=boÅŸ, col8=HAKEM formatÄ±
  const hakemIdxs = headers.reduce((acc,h,i)=>{ if(h&&h.includes('HAKEM')) acc.push(i); return acc; },[]);
  const cH1 = hakemIdxs.length>0 ? hakemIdxs[0] : 6;
  const cH2 = hakemIdxs.length>1 ? hakemIdxs[1] : (hakemIdxs.length>0 ? hakemIdxs[0]+2 : 8);

  const rows=[];
  let lastTarih='';
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(sep).map(s=>s.trim().replace(/^["']|["']$/g,''));
    if(c.every(x=>!x)) continue;
    // Tarih boÅŸsa Ã¶nceki tarihi devral (birleÅŸtirilmiÅŸ hÃ¼cre durumu)
    const tarih = c[cTarih]||lastTarih;
    if(tarih) lastTarih=tarih;
    if(!tarih && !c[cOrg]) continue;
    rows.push({
      tarih,
      saat:  c[cSaat]  ||'',
      salon: c[cSalon] ||'',
      org:   c[cOrg]   ||'',
      grup:  c[cGrup]  ||'',
      h1:    cH1<c.length ? c[cH1]||'' : '',
      h2:    cH2<c.length ? c[cH2]||'' : ''
    });
  }
  return rows;
}

// â”€â”€ Ã–ZEL parse â”€â”€
// TARÄ°H | SALON | SAAT | A TAKIMI | B TAKIMI | ORGANÄ°ZASYON | KATEGORÄ° | HAKEM | HAKEM
function parseOzel(text) {
  const r = splitCsv(text); if (!r) return null;
  const { sep, lines } = r;
  const headers = lines[0].split(sep).map(normH);
  const fi = (...ns) => { for (const n of ns) { const i=headers.findIndex(h=>h.includes(n)); if(i>=0)return i; } return -1; };
  const cTarih=fi('TARIH'), cSalon=fi('SALON','YER'), cSaat=fi('SAAT');
  const cA=fi('ATAKIMI','ATAKM'), cB=fi('BTAKIMI','BTAKM','DEPLASMAN','MISAFIR');
  const cOrg=fi('ORGANIZASYON','ORG'), cKat=fi('KATEGORI','KAT');
  const hakemIdxs = headers.reduce((acc,h,i)=>{ if(h.includes('HAKEM')) acc.push(i); return acc; },[]);
  const cH1=hakemIdxs[0]??-1, cH2=hakemIdxs[1]??-1;
  if(cTarih<0||cA<0||cB<0) return {error:'Zorunlu sÃ¼tunlar bulunamadÄ±: TARÄ°H, A TAKIMI, B TAKIMI\nBaÅŸlÄ±k: '+lines[0].substring(0,100)};
  // Format doÄŸrulama: Ã–zel Lig CSV'sinde ORGANÄ°ZASYON olmalÄ±, 1.HAKEM/2.HAKEM (numaralÄ±) olmamalÄ±
  const hasOrg2 = fi('ORGANIZASYON','ORG') >= 0;
  const hasNumberedRef2 = fi('1HAKEM','BIRINCI') >= 0 || fi('2HAKEM','IKINCI') >= 0;
  if (!hasOrg2) return {error:'âŒ Bu CSV Ã–zel Lig & Ãœniversite formatÄ±nda deÄŸil!\n\nÃ–zel Lig CSV formatÄ±: TARÄ°H Â· SALON Â· SAAT Â· A TAKIMI Â· B TAKIMI Â· ORGANÄ°ZASYON Â· KATEGORÄ° Â· HAKEM Â· HAKEM\n\nYÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z dosya BÃ¶lge MaÃ§Ä± formatÄ±nda gÃ¶rÃ¼nÃ¼yor.'};
  if (hasNumberedRef2) return {error:'âŒ Bu CSV Ã–zel Lig & Ãœniversite formatÄ±nda deÄŸil!\n\nÃ–zel Lig CSV formatÄ±: TARÄ°H Â· SALON Â· SAAT Â· A TAKIMI Â· B TAKIMI Â· ORGANÄ°ZASYON Â· KATEGORÄ° Â· HAKEM Â· HAKEM\n\nYÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ±z dosya BÃ¶lge MaÃ§Ä± formatÄ±nda gÃ¶rÃ¼nÃ¼yor.'};
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const c=lines[i].split(sep).map(s=>s.trim().replace(/^["']|["']$/g,''));
    if(c.every(x=>!x)) continue;
    rows.push({tarih:c[cTarih]||'',salon:cSalon>=0?c[cSalon]||'':'',saat:cSaat>=0?c[cSaat]||'':'',
               a:c[cA]||'',b:c[cB]||'',org:cOrg>=0?c[cOrg]||'':'',kat:cKat>=0?c[cKat]||'':'',
               h1:cH1>=0?c[cH1]||'':'',h2:cH2>=0?c[cH2]||'':''});
  }
  return rows;
}

// â”€â”€ Genel dosya handler â”€â”€
window.handleCsv = function(event, cat) {
  const file = event.target.files[0]; if(!file) return;
  document.getElementById('csv-'+cat+'-error').style.display='none';
  document.getElementById('csv-'+cat+'-preview').style.display='none';
  const reader = new FileReader();
  reader.onload = e => {
    try {
      let result;
      if (cat==='bolge') result=parseBolge(e.target.result);
      else if(cat==='okul') result=parseOkul(e.target.result);
      else result=parseOzel(e.target.result);
      if (!result) { showCsvErr(cat,'Dosya okunamadÄ±'); return; }
      if (result.error) { showCsvErr(cat, result.error); return; }
      if (!result.length) { showCsvErr(cat,'GeÃ§erli satÄ±r bulunamadÄ±'); return; }
      _csvData[cat] = result;
      renderCsvPreview(cat, result);
    } catch(err) { showCsvErr(cat, 'Hata: '+err.message); }
  };
  reader.readAsText(file,'UTF-8');
  event.target.value='';
};

// â”€â”€ Ã–nizleme render â”€â”€
function renderCsvPreview(cat, rows) {
  const mine = rows.filter(r=>myRole2(r.h1,r.h2)!=='â€”').length;
  let html='';

  if(cat==='bolge') {
    html=rows.map(r=>{
      const rol=myRole2(r.h1,r.h2), isMine=rol!=='â€”';
      return `<tr style="${isMine?'background:rgba(249,115,22,.07)':''}">
        <td style="font-size:11px;white-space:nowrap">${r.tarih}</td><td style="font-size:11px">${r.salon}</td>
        <td><strong>${r.saat}</strong></td><td style="font-size:12px">${r.ev}</td><td style="font-size:12px">${r.dep}</td>
        <td><span class="badge b-orange" style="font-size:10px">${r.kat}</span></td>
        <td style="font-size:11px;color:var(--muted)">${r.grup}</td>
        <td style="font-size:11px;color:var(--muted2)">${r.h1}</td><td style="font-size:11px;color:var(--muted2)">${r.h2}</td>
        <td>${isMine?`<span class="role-badge">${rol}</span>`:'<span style="color:var(--muted);font-size:10px">â€”</span>'}</td>
      </tr>`;
    }).join('');
  } else if(cat==='okul') {
    html=rows.map(r=>{
      const rol=myRole2(r.h1,r.h2), isMine=rol!=='â€”';
      return `<tr style="${isMine?'background:rgba(34,197,94,.07)':''}">
        <td style="font-size:11px;white-space:nowrap">${r.tarih}</td><td><strong>${r.saat}</strong></td>
        <td style="font-size:11px">${r.salon}</td><td style="font-size:12px">${r.org}</td>
        <td style="font-size:11px;color:var(--muted)">${r.grup}</td>
        <td style="font-size:11px;color:var(--muted2)">${r.h1}</td><td style="font-size:11px;color:var(--muted2)">${r.h2}</td>
        <td>${isMine?`<span class="role-badge">${rol}</span>`:'<span style="color:var(--muted);font-size:10px">â€”</span>'}</td>
      </tr>`;
    }).join('');
  } else {
    html=rows.map(r=>{
      const rol=myRole2(r.h1,r.h2), isMine=rol!=='â€”';
      return `<tr style="${isMine?'background:rgba(96,165,250,.07)':''}">
        <td style="font-size:11px;white-space:nowrap">${r.tarih}</td><td style="font-size:11px">${r.salon}</td>
        <td><strong>${r.saat}</strong></td><td style="font-size:12px">${r.a}</td><td style="font-size:12px">${r.b}</td>
        <td style="font-size:11px">${r.org}</td><td><span class="badge b-blue" style="font-size:10px">${r.kat}</span></td>
        <td style="font-size:11px;color:var(--muted2)">${r.h1}</td><td style="font-size:11px;color:var(--muted2)">${r.h2}</td>
        <td>${isMine?`<span class="role-badge">${rol}</span>`:'<span style="color:var(--muted);font-size:10px">â€”</span>'}</td>
      </tr>`;
    }).join('');
  }

  document.getElementById('csv-'+cat+'-body').innerHTML = html;
  document.getElementById('csv-'+cat+'-cnt').textContent = rows.length;
  document.getElementById('csv-'+cat+'-mine').textContent = mine ? 'Â· â­ '+mine+' senin maÃ§Ä±n' : '';
  document.getElementById('csv-'+cat+'-preview').style.display='';
}

window.csvReset = function(cat) {
  _csvData[cat]=[];
  document.getElementById('csv-'+cat+'-preview').style.display='none';
  document.getElementById('csv-'+cat+'-error').style.display='none';
};

// â”€â”€ Kaydet â”€â”€
window.csvSave = function(cat) {
  const rows = _csvData[cat];
  if (!rows.length) return;

  if (cat==='bolge') {
    const weekNo = parseInt(document.getElementById('csv-bolge-week').value);
    if (!weekNo||weekNo<1||weekNo>52) { showCsvErr('bolge','GeÃ§erli hafta numarasÄ± gir (1-52)'); return; }
    if (!HAFTA[weekNo]) HAFTA[weekNo]=[];
    let added=0;
    for(const r of rows){
      const dup=HAFTA[weekNo].some(e=>e.tarih===r.tarih&&e.ev===r.ev&&e.dep===r.dep);
      if(!dup){ HAFTA[weekNo].push(r); added++; }
    }
    updateWeekSelect(weekNo);
    csvStoreSave('bolge',weekNo,rows);
    const mine=rows.filter(r=>myRole2(r.h1,r.h2)!=='â€”').length;
    toast('âœ… '+weekNo+'. Hafta eklendi! '+added+' maÃ§ (â­'+mine+' senin)','ok');
    csvReset('bolge');
    renderCsvHistory('bolge');
    progTab('hafta');
    setTimeout(()=>{ const s=document.getElementById('ph-week'); if(s){s.value=String(weekNo);renderHafta();} },100);

  } else if(cat==='okul') {
    const newEntries=rows.map(r=>({tarih:r.tarih,saat:r.saat,salon:r.salon,org:r.org,grup:r.grup,h1:r.h1,h2:r.h2}));
    let added=0;
    for(const e of newEntries){
      const dup=OKUL.current.some(x=>x.tarih===e.tarih&&x.org===e.org&&x.saat===e.saat);
      if(!dup){ OKUL.current.push(e); added++; }
    }
    csvStoreSave('okul','current',rows);
    const mine=rows.filter(r=>myRole2(r.h1,r.h2)!=='â€”').length;
    toast('âœ… Okul programÄ± eklendi! '+added+' maÃ§ (â­'+mine+' senin)','ok');
    csvReset('okul');
    renderCsvHistory('okul');
    progTab('okul');
    setTimeout(()=>renderOkul(),100);

  } else {
    const newEntries=rows.map(r=>({tarih:r.tarih,salon:r.salon,saat:r.saat,a:r.a,b:r.b,org:r.org,kat:r.kat,h1:r.h1,h2:r.h2}));
    let added=0;
    for(const e of newEntries){
      const key = e.tarih+'|'+e.saat+'|'+e.salon+'|'+(e.a||e.org||'');
      const dup=OZEL.some(x=>(x.tarih+'|'+x.saat+'|'+x.salon+'|'+(x.a||x.org||''))===key);
      if(!dup){ OZEL.push(e); added++; }
    }
    csvStoreSave('ozel','ozel',rows);
    const mine=rows.filter(r=>myRole2(r.h1,r.h2)!=='â€”').length;
    toast('âœ… Ã–zel lig programÄ± eklendi! '+added+' maÃ§ (â­'+mine+' senin)','ok');
    csvReset('ozel');
    renderCsvHistory('ozel');
    progTab('ozel');
    setTimeout(()=>renderOzel(),100);
  }
};

// â”€â”€ Storage â”€â”€
function csvStoreSave(cat, key, rows) {
  try {
    const sk='rt_csv2_'+cat+'_'+key;
    const ex=JSON.parse(LS.getItem(sk)||'[]');
    const merged=[...ex];
    for(const r of rows){
      const rk = r.tarih+'|'+(r.saat||'')+'|'+(r.salon||r.ev||'')+'|'+(r.a||r.ev||r.org||'');
      const dup=merged.some(x=>(x.tarih+'|'+(x.saat||'')+'|'+(x.salon||x.ev||'')+'|'+(x.a||x.ev||x.org||''))===rk);
      if(!dup) merged.push(r);
    }
    LS.setItem(sk,JSON.stringify(merged));
    // index
    const idx=JSON.parse(LS.getItem('rt_csv2_idx_'+cat)||'[]');
    if(!idx.includes(String(key))){ idx.push(String(key)); }
    LS.setItem('rt_csv2_idx_'+cat,JSON.stringify(idx));
    LS.setItem(sk+'_date',new Date().toLocaleDateString('tr-TR'));
  } catch(e){console.error(e);}
}

function loadCsvFromStorage() {
  try {
    // BÃ¶lge haftalarÄ±
    const bKeys=JSON.parse(LS.getItem('rt_csv2_idx_bolge')||'[]');
    for(const k of bKeys){
      const rows=JSON.parse(LS.getItem('rt_csv2_bolge_'+k)||'[]');
      const wk=parseInt(k); if(!wk) continue;
      if(!HAFTA[wk]) HAFTA[wk]=[];
      for(const r of rows){ const dup=HAFTA[wk].some(e=>e.tarih===r.tarih&&e.ev===r.ev&&e.dep===r.dep); if(!dup) HAFTA[wk].push(r); }
      updateWeekSelect(wk);
    }
    // Okul
    const oRows=JSON.parse(LS.getItem('rt_csv2_okul_current')||'[]');
    for(const r of oRows){ const dup=OKUL.current.some(x=>x.tarih===r.tarih&&x.org===r.org&&x.saat===r.saat); if(!dup) OKUL.current.push(r); }
    // Ã–zel
    const zRows=JSON.parse(LS.getItem('rt_csv2_ozel_ozel')||'[]');
    for(const r of zRows){ const rk=r.tarih+'|'+(r.saat||'')+'|'+(r.salon||'')+'|'+(r.a||r.org||''); const dup=OZEL.some(x=>(x.tarih+'|'+(x.saat||'')+'|'+(x.salon||'')+'|'+(x.a||x.org||''))===rk); if(!dup) OZEL.push(r); }
  } catch(e){console.error('CSV load',e);}
}

function renderCsvHistory(cat) {
  if(!cat) cat=_csvCat;

  if(cat==='bolge'){
    const el=document.getElementById('csv-bolge-history'); if(!el) return;
    const keys=JSON.parse(LS.getItem('rt_csv2_idx_bolge')||'[]');
    if(!keys.length){ el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:6px 0">HenÃ¼z yÃ¼klenmedi</div>'; return; }
    el.innerHTML=keys.slice().reverse().map(k=>{
      const rows=JSON.parse(LS.getItem('rt_csv2_bolge_'+k)||'[]');
      const mine=rows.filter(r=>myRole2(r.h1||'',r.h2||'')!=='â€”').length;
      const date=LS.getItem('rt_csv2_bolge_'+k+'_date')||'â€”';
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surf2);border-radius:8px;margin-bottom:7px;border:1px solid var(--border)">
        <div><div style="font-size:13px;font-weight:600">${k}. Hafta <span style="color:var(--acc);font-size:11px">(${rows.length} maÃ§ Â· â­${mine} senin)</span></div>
        <div style="font-size:10px;color:var(--muted)">YÃ¼klenme: ${date}</div></div>
        <div style="display:flex;gap:7px">
          <button class="btn btn-ghost btn-sm" onclick="progTab('hafta');setTimeout(()=>{document.getElementById('ph-week').value='${k}';renderHafta();},80)">ğŸ‘</button>
          <button class="btn btn-danger btn-sm" onclick="csvDelBolge(${k})">ğŸ—‘</button>
        </div></div>`;
    }).join('');
  } else if(cat==='okul'){
    const el=document.getElementById('csv-okul-history'); if(!el) return;
    const rows=JSON.parse(LS.getItem('rt_csv2_okul_current')||'[]');
    if(!rows.length){ el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:6px 0">HenÃ¼z yÃ¼klenmedi</div>'; return; }
    const mine=rows.filter(r=>myRole2(r.h1||'',r.h2||'')!=='â€”').length;
    const date=LS.getItem('rt_csv2_okul_current_date')||'â€”';
    el.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surf2);border-radius:8px;border:1px solid var(--border)">
      <div><div style="font-size:13px;font-weight:600">Okul ProgramÄ± <span style="color:var(--green);font-size:11px">(${rows.length} maÃ§ Â· â­${mine} senin)</span></div>
      <div style="font-size:10px;color:var(--muted)">YÃ¼klenme: ${date}</div></div>
      <div style="display:flex;gap:7px">
        <button class="btn btn-ghost btn-sm" onclick="progTab('okul')">ğŸ‘</button>
        <button class="btn btn-danger btn-sm" onclick="csvDelOkul()">ğŸ—‘</button>
      </div></div>`;
  } else {
    const el=document.getElementById('csv-ozel-history'); if(!el) return;
    const rows=JSON.parse(LS.getItem('rt_csv2_ozel_ozel')||'[]');
    if(!rows.length){ el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:6px 0">HenÃ¼z yÃ¼klenmedi</div>'; return; }
    const mine=rows.filter(r=>myRole2(r.h1||'',r.h2||'')!=='â€”').length;
    const date=LS.getItem('rt_csv2_ozel_ozel_date')||'â€”';
    el.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surf2);border-radius:8px;border:1px solid var(--border)">
      <div><div style="font-size:13px;font-weight:600">Ã–zel Lig ProgramÄ± <span style="color:#60a5fa;font-size:11px">(${rows.length} maÃ§ Â· â­${mine} senin)</span></div>
      <div style="font-size:10px;color:var(--muted)">YÃ¼klenme: ${date}</div></div>
      <div style="display:flex;gap:7px">
        <button class="btn btn-ghost btn-sm" onclick="progTab('ozel')">ğŸ‘</button>
        <button class="btn btn-danger btn-sm" onclick="csvDelOzel()">ğŸ—‘</button>
      </div></div>`;
  }
}

window.csvDelBolge = function(weekNo) {
  if(!confirm(weekNo+'. haftayÄ± silmek istediÄŸinizden emin misiniz?')) return;
  LS.removeItem('rt_csv2_bolge_'+weekNo);
  LS.removeItem('rt_csv2_bolge_'+weekNo+'_date');
  const idx=JSON.parse(LS.getItem('rt_csv2_idx_bolge')||'[]').filter(k=>String(k)!==String(weekNo));
  LS.setItem('rt_csv2_idx_bolge',JSON.stringify(idx));
  delete HAFTA[weekNo];
  const sel=document.getElementById('ph-week');
  if(sel){ const o=[...sel.options].find(o=>o.value===String(weekNo)); if(o)sel.removeChild(o); }
  renderCsvHistory('bolge');
  toast(weekNo+'. hafta silindi','');
};
window.csvDelOkul = function() {
  if(!confirm('Okul programÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;
  const rows=JSON.parse(LS.getItem('rt_csv2_okul_current')||'[]');
  const toDel=new Set(rows.map(r=>r.tarih+'|'+r.org+'|'+r.saat));
  OKUL.current=OKUL.current.filter(x=>!toDel.has(x.tarih+'|'+x.org+'|'+x.saat));
  LS.removeItem('rt_csv2_okul_current');
  LS.removeItem('rt_csv2_okul_current_date');
  LS.setItem('rt_csv2_idx_okul',JSON.stringify([]));
  renderCsvHistory('okul'); renderOkul();
  toast('Okul programÄ± silindi','');
};
window.csvDelOzel = function() {
  if(!confirm('Ã–zel lig programÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;
  const rows=JSON.parse(LS.getItem('rt_csv2_ozel_ozel')||'[]');
  const toDel=new Set(rows.map(r=>r.tarih+'|'+r.a+'|'+r.b));
  for(let i=OZEL.length-1;i>=0;i--){ if(toDel.has(OZEL[i].tarih+'|'+OZEL[i].a+'|'+OZEL[i].b)) OZEL.splice(i,1); }
  LS.removeItem('rt_csv2_ozel_ozel');
  LS.removeItem('rt_csv2_ozel_ozel_date');
  LS.setItem('rt_csv2_idx_ozel',JSON.stringify([]));
  renderCsvHistory('ozel'); renderOzel();
  toast('Ã–zel lig programÄ± silindi','');
};

function updateWeekSelect(weekNo) {
  const sel=document.getElementById('ph-week'); if(!sel) return;
  if([...sel.options].some(o=>o.value===String(weekNo))) return;
  const opt=document.createElement('option');
  opt.value=weekNo; opt.textContent=weekNo+'. Hafta';
  const opts=[...sel.options].filter(o=>o.value!=='');
  let ins=false;
  for(const o of opts){ if(parseInt(o.value)>weekNo){ sel.insertBefore(opt,o); ins=true; break; } }
  if(!ins) sel.appendChild(opt);
}

function showCsvErr(cat, msg) {
  const el=document.getElementById('csv-'+cat+'-error');
  if(el){ el.textContent='âš ï¸ '+msg; el.style.display=''; }
}


// â”€â”€â”€ PWA MANIFEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('pwa-manifest').href = URL.createObjectURL(new Blob([JSON.stringify({
  name: "RefTrack â€” Hakem Paneli",
  short_name: "RefTrack",
  start_url: "?pwa=1",
  display: "browser",
  background_color: "#090b0f",
  theme_color: "#090b0f",
  icons: [{src:"https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/72x72/1f3c0.png",sizes:"72x72",type:"image/png"}]
})],{type:'application/json'}));

if (typeof Notification !== 'undefined') updatePermUI();
} catch(e) {
  console.error('Firebase init error:', e);
  document.getElementById('loading').style.display='none';
  const errEl=document.getElementById('login-error');
  if(errEl){errEl.style.display='';errEl.textContent='BaÄŸlantÄ± hatasÄ±: '+e.message;}
}
})();
</script>
</body>
</html>
